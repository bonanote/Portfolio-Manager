<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Portfolio Return Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background: #f0f4f8; color: #333; font-size: 13px; }
  h1 { text-align: center; color: #1a1a1a; margin-bottom: 5px; }
  .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9em; }

  /* Main Layout */
  .container { max-width: 100%; margin: 0 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

  /* Global Controls - Grid for Dates */
  .date-grid { display: grid; grid-template-columns: repeat(5, 1fr) auto; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; align-items: end; }
  .control-group { display: flex; flex-direction: column; gap: 4px; }
  .control-group label { font-size: 11px; font-weight: 700; color: #666; text-transform: uppercase; }
  .control-group input { width: 100%; font-size: 12px; }
  
  /* Table */
  .table-wrapper { overflow-x: auto; margin-bottom: 20px; border: 1px solid #eee; border-radius: 6px; }
  table { width: 100%; border-collapse: collapse; min-width: 1600px; }
  
  th { 
    text-align: left; 
    font-size: 11px; 
    color: #555; 
    text-transform: uppercase; 
    padding: 8px; 
    border-bottom: 2px solid #ddd; 
    background: #f9f9f9;
    white-space: nowrap; 
    user-select: none;
  }
  
  /* Column Grouping Colors */
  .th-start { background: #e3f2fd; border-bottom: 2px solid #90caf9; }
  .th-mid { background: #fff3e0; border-bottom: 2px solid #ffe0b2; }
  .th-end { background: #e8f5e9; border-bottom: 2px solid #a5d6a7; }
  .th-res { background: #f3e5f5; border-bottom: 2px solid #ce93d8; }

  td { padding: 6px 8px; border-bottom: 1px solid #f1f1f1; vertical-align: middle; }
  
  /* Inputs in Table */
  input { padding: 6px; border: 1px solid #dfe3e8; border-radius: 3px; font-size: 13px; width: 100%; box-sizing: border-box; transition: border 0.2s; }
  input:focus { border-color: #007bff; outline: none; background: #f9fbff; }
  
  .ticker-input { text-transform: uppercase; font-weight: bold; width: 60px; }
  .num-input { width: 70px; }
  .price-input { width: 70px; font-weight: 500; text-align: right; }
  
  /* Read-only Calculations */
  .calc-val { font-size: 13px; font-weight: 500; display: block; text-align: right; }
  .gain-val { font-weight: 700; }
  .div-val { color: #28a745; font-size: 12px; }

  /* Buttons */
  .btn { padding: 8px 14px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
  .btn-primary { background: #007bff; color: white; }
  .btn-magic { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .btn-csv { background: #28a745; color: white; }
  .btn-add { background: #e9ecef; color: #333; border: 1px solid #ced4da; }
  .btn-remove { background: transparent; color: #dc3545; border: 1px solid transparent; font-size: 16px; padding: 2px 6px; }
  .btn:hover { opacity: 0.9; }
  .btn-remove:hover { background: #fee; border-color: #fcc; }

  /* Yahoo Link */
  .yahoo-link {
    display: inline-flex; align-items: center; justify-content: center;
    background: #720e9e; color: white; text-decoration: none;
    font-size: 10px; font-weight: bold; width: 20px; height: 20px;
    border-radius: 3px; margin-left: 4px;
  }

  /* Summary Section */
  .summary-panel { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
    gap: 15px; 
    margin-top: 20px; 
    padding-top: 20px; 
    border-top: 2px solid #eee; 
  }
  .summary-card { background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; }
  .sum-label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 4px; }
  .sum-value { font-size: 18px; font-weight: 800; color: #333; }
  .sum-sub { font-size: 12px; font-weight: 600; margin-top: 2px; }
  
  .positive { color: #28a745; }
  .negative { color: #dc3545; }

  /* AI Panel */
  #ai-response-area { margin-top: 20px; padding: 20px; background: #fff0f6; border: 1px solid #ffc9e0; border-radius: 12px; display: none; }
  #ai-response-content { font-size: 14px; line-height: 1.5; color: #444; }
  .ai-loading { color: #d63384; font-style: italic; }
</style>
</head>
<body>

<h1>Portfolio Growth Analyzer</h1>
<div class="subtitle">Track Portfolio Evolution Across 5 Time Points</div>

<div class="container">

  <!-- 1. Global Date Controls -->
  <div class="date-grid">
    <div class="control-group">
      <label>Start Date (Cost Basis)</label>
      <input type="date" id="date0" onchange="calculateAll()" style="border-left: 3px solid #90caf9;">
    </div>
    <div class="control-group">
      <label>Intermediate Date 1</label>
      <input type="date" id="date1" onchange="calculateAll()" style="border-left: 3px solid #ffe0b2;">
    </div>
    <div class="control-group">
      <label>Intermediate Date 2</label>
      <input type="date" id="date2" onchange="calculateAll()" style="border-left: 3px solid #ffe0b2;">
    </div>
    <div class="control-group">
      <label>Intermediate Date 3</label>
      <input type="date" id="date3" onchange="calculateAll()" style="border-left: 3px solid #ffe0b2;">
    </div>
    <div class="control-group">
      <label>End Date (Current)</label>
      <input type="date" id="date4" onchange="calculateAll()" style="border-left: 3px solid #a5d6a7;">
    </div>
    
    <div class="control-group" style="justify-content: flex-end;">
       <div style="display:flex; gap:5px;">
         <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)">
         <button class="btn btn-csv" onclick="document.getElementById('csvInput').click()" title="Import CSV">ðŸ“‚</button>
         <button class="btn btn-magic" onclick="fetchAllYahoo()">âœ¨ Fetch</button>
         <button class="btn btn-export" onclick="downloadCSV()">ðŸ“¥ Export</button>
       </div>
       <div id="statusMsg" style="font-size:10px; text-align:right; margin-top:4px;"></div>
    </div>
  </div>
  
  <div style="font-size:11px; margin-bottom:10px; text-align:right;">
      <details>
        <summary style="cursor:pointer; color:#007bff;">API Settings</summary>
        <div style="position:absolute; background:white; padding:10px; border:1px solid #ccc; border-radius:4px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-top:5px; right: 40px; width:250px; z-index: 10; text-align:left;">
           <label>Gemini API Key</label>
           <input type="text" id="geminiKey" placeholder="Optional" style="margin-top:5px;">
           <button class="btn btn-sm btn-primary" onclick="saveKeys()" style="margin-top:5px; width:100%;">Save</button>
        </div>
      </details>
  </div>

  <!-- 2. Main Table -->
  <div class="table-wrapper">
    <table id="pfTable">
      <thead>
        <tr>
          <th width="90">Ticker</th>
          <th width="70">Shares</th>
          
          <!-- Start -->
          <th class="th-start" width="80">Start Price</th>
          <th class="th-start" width="100">Initial Cost</th>
          
          <!-- Date 1 -->
          <th class="th-mid" width="80">Price 1</th>
          <th class="th-mid" width="100">Value 1</th>
          
          <!-- Date 2 -->
          <th class="th-mid" width="80">Price 2</th>
          <th class="th-mid" width="100">Value 2</th>
          
          <!-- Date 3 -->
          <th class="th-mid" width="80">Price 3</th>
          <th class="th-mid" width="100">Value 3</th>
          
          <!-- End -->
          <th class="th-end" width="80">End Price</th>
          <th class="th-end" width="100">Final Value</th>
          
          <!-- Results -->
          <th class="th-res" width="90">Total Divs</th>
          <th class="th-res" width="100">Total Gain</th>
          <th class="th-res" width="70">Ret %</th>
          <th width="30"></th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Rows Generated Here -->
      </tbody>
    </table>
  </div>

  <button class="btn btn-add" onclick="addRow()">+ Add Stock</button>

  <!-- 3. Summary Footer -->
  <div class="summary-panel">
    <div class="summary-card" style="border-bottom: 3px solid #90caf9;">
      <div class="sum-label">Start Value</div>
      <div class="sum-value" id="sumVal0">$0.00</div>
    </div>
    <div class="summary-card" style="border-bottom: 3px solid #ffe0b2;">
      <div class="sum-label">Value @ Date 1</div>
      <div class="sum-value" id="sumVal1">$0.00</div>
    </div>
    <div class="summary-card" style="border-bottom: 3px solid #ffe0b2;">
      <div class="sum-label">Value @ Date 2</div>
      <div class="sum-value" id="sumVal2">$0.00</div>
    </div>
    <div class="summary-card" style="border-bottom: 3px solid #ffe0b2;">
      <div class="sum-label">Value @ Date 3</div>
      <div class="sum-value" id="sumVal3">$0.00</div>
    </div>
    <div class="summary-card" style="border-bottom: 3px solid #a5d6a7;">
      <div class="sum-label">End Value</div>
      <div class="sum-value" id="sumVal4">$0.00</div>
    </div>
    
    <div class="summary-card" style="background:#e3f2fd;">
      <div class="sum-label">Total Gain (w/ Divs)</div>
      <div class="sum-value" id="sumTotalGain">$0.00</div>
      <div class="sum-sub" id="sumTotalPct">0.00%</div>
    </div>
    
    <!-- AI Analysis Button -->
    <div class="summary-card" style="background:#fff0f6; cursor:pointer; border:1px solid #ffc9e0;" onclick="analyzePortfolio()">
        <div class="sum-label" style="color:#d63384;">AI Insights</div>
        <div style="font-weight:bold; color:#d63384; font-size:12px; margin-top:5px;">
            âœ¨ Analyze Trend
        </div>
    </div>
  </div>

  <!-- AI Response Container -->
  <div id="ai-response-area">
      <div id="ai-response-content"></div>
  </div>

</div>

<script>
// --- CONFIG ---
let rowCount = 0;
// Default Dates: Start 2021, Intermediates 2022-2024, End Today
const today = dayjs();
document.getElementById('date0').value = "2021-01-04";
document.getElementById('date1').value = "2021-12-31";
document.getElementById('date2').value = "2022-12-30";
document.getElementById('date3').value = "2023-12-29";
document.getElementById('date4').value = today.format("YYYY-MM-DD");

// Init
const savedGeminiKey = localStorage.getItem('gemini_key');
if(savedGeminiKey) document.getElementById('geminiKey').value = savedGeminiKey;

['AAPL', 'MSFT', 'GOOGL'].forEach(t => addRow(t));

// --- CORE FUNCTIONS ---

function saveKeys() {
    localStorage.setItem('gemini_key', document.getElementById('geminiKey').value.trim());
    alert("Key Saved");
}

function updateYahooLink(id) {
    const row = document.getElementById(`row-${id}`);
    const input = row.querySelector('.ticker-input');
    let val = input.value.toUpperCase().replace(/\s/g, '');
    if(input.value !== val) input.value = val;
    const link = row.querySelector('.yahoo-link');
    if(val) link.href = `https://finance.yahoo.com/quote/${val}`;
}

function addRow(ticker = '', initialShares = 10) {
    rowCount++;
    const tbody = document.getElementById('tableBody');
    const tr = document.createElement('tr');
    tr.id = `row-${rowCount}`;
    tr.dataset.divPerShare = "0"; 
    
    ticker = ticker.toUpperCase().replace(/\s/g, '');

    tr.innerHTML = `
      <td>
        <div style="display:flex; align-items:center;">
          <input type="text" class="ticker-input" value="${ticker}" placeholder="SYM" oninput="updateYahooLink(${rowCount})">
          <a href="https://finance.yahoo.com/quote/${ticker}" target="_blank" class="yahoo-link">Y!</a>
        </div>
      </td>
      <td><input type="number" class="num-input" value="${initialShares}" step="any" oninput="calcRow(${rowCount})"></td>
      
      <!-- Start -->
      <td><input type="number" class="price-input p0" placeholder="0.00" oninput="calcRow(${rowCount})"></td>
      <td><span class="calc-val v0">$0.00</span></td>
      
      <!-- Date 1 -->
      <td><input type="number" class="price-input p1" placeholder="0.00" oninput="calcRow(${rowCount})"></td>
      <td><span class="calc-val v1">$0.00</span></td>
      
      <!-- Date 2 -->
      <td><input type="number" class="price-input p2" placeholder="0.00" oninput="calcRow(${rowCount})"></td>
      <td><span class="calc-val v2">$0.00</span></td>
      
      <!-- Date 3 -->
      <td><input type="number" class="price-input p3" placeholder="0.00" oninput="calcRow(${rowCount})"></td>
      <td><span class="calc-val v3">$0.00</span></td>
      
      <!-- End -->
      <td><input type="number" class="price-input p4" placeholder="0.00" oninput="calcRow(${rowCount})"></td>
      <td><span class="calc-val v4">$0.00</span></td>
      
      <!-- Results -->
      <td><span class="calc-val div-val">$0.00</span></td>
      <td><span class="calc-val gain-val">$0.00</span></td>
      <td><span class="calc-val pct-val">0%</span></td>
      <td><button class="btn btn-remove" onclick="removeRow(${rowCount})">Ã—</button></td>
    `;
    tbody.appendChild(tr);
    calcRow(rowCount);
}

function removeRow(id) {
    document.getElementById(`row-${id}`)?.remove();
    calculateAll();
}

function calcRow(id) {
    const row = document.getElementById(`row-${id}`);
    if(!row) return;

    const shares = parseFloat(row.querySelector('.num-input').value) || 0;
    const p0 = parseFloat(row.querySelector('.p0').value) || 0;
    const p1 = parseFloat(row.querySelector('.p1').value) || 0;
    const p2 = parseFloat(row.querySelector('.p2').value) || 0;
    const p3 = parseFloat(row.querySelector('.p3').value) || 0;
    const p4 = parseFloat(row.querySelector('.p4').value) || 0;
    
    // Values
    row.querySelector('.v0').textContent = fmtMoney(shares * p0);
    row.querySelector('.v1').textContent = fmtMoney(shares * p1);
    row.querySelector('.v2').textContent = fmtMoney(shares * p2);
    row.querySelector('.v3').textContent = fmtMoney(shares * p3);
    row.querySelector('.v4').textContent = fmtMoney(shares * p4);

    // Dividends & Total Gain
    const divPerShare = parseFloat(row.dataset.divPerShare) || 0;
    const totalDivs = shares * divPerShare;
    row.querySelector('.div-val').textContent = fmtMoney(totalDivs);

    const initialVal = shares * p0;
    const finalVal = shares * p4;
    const totalGain = (finalVal + totalDivs) - initialVal;
    const pct = initialVal > 0 ? (totalGain / initialVal) * 100 : 0;

    const gainEl = row.querySelector('.gain-val');
    gainEl.textContent = (totalGain >= 0 ? "+" : "") + fmtMoney(totalGain);
    gainEl.style.color = totalGain >= 0 ? "#28a745" : "#dc3545";
    
    const pctEl = row.querySelector('.pct-val');
    pctEl.textContent = pct.toFixed(1) + "%";
    pctEl.style.color = totalGain >= 0 ? "#28a745" : "#dc3545";

    updateSummary();
}

function calculateAll() {
    document.querySelectorAll('#tableBody tr').forEach(tr => {
        calcRow(tr.id.split('-')[1]);
    });
}

function updateSummary() {
    let totals = [0, 0, 0, 0, 0]; // For Dates 0-4
    let totalDivs = 0;

    document.querySelectorAll('#tableBody tr').forEach(tr => {
        const shares = parseFloat(tr.querySelector('.num-input').value) || 0;
        totals[0] += shares * (parseFloat(tr.querySelector('.p0').value) || 0);
        totals[1] += shares * (parseFloat(tr.querySelector('.p1').value) || 0);
        totals[2] += shares * (parseFloat(tr.querySelector('.p2').value) || 0);
        totals[3] += shares * (parseFloat(tr.querySelector('.p3').value) || 0);
        totals[4] += shares * (parseFloat(tr.querySelector('.p4').value) || 0);
        totalDivs += shares * (parseFloat(tr.dataset.divPerShare) || 0);
    });

    document.getElementById('sumVal0').textContent = fmtMoney(totals[0]);
    document.getElementById('sumVal1').textContent = fmtMoney(totals[1]);
    document.getElementById('sumVal2').textContent = fmtMoney(totals[2]);
    document.getElementById('sumVal3').textContent = fmtMoney(totals[3]);
    document.getElementById('sumVal4').textContent = fmtMoney(totals[4]);

    const totalGain = (totals[4] + totalDivs) - totals[0];
    const totalPct = totals[0] > 0 ? (totalGain / totals[0]) * 100 : 0;

    const gainEl = document.getElementById('sumTotalGain');
    gainEl.textContent = (totalGain >= 0 ? "+" : "") + fmtMoney(totalGain);
    gainEl.className = "sum-value " + (totalGain >= 0 ? "positive" : "negative");
    
    const pctEl = document.getElementById('sumTotalPct');
    pctEl.textContent = totalPct.toFixed(2) + "%";
    pctEl.className = "sum-sub " + (totalPct >= 0 ? "positive" : "negative");
}

function fmtMoney(n) { return "$" + n.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }

// --- FETCH LOGIC ---

async function fetchAllYahoo() {
    const dates = [
        document.getElementById('date0').value,
        document.getElementById('date1').value,
        document.getElementById('date2').value,
        document.getElementById('date3').value,
        document.getElementById('date4').value
    ];
    
    if (dates.some(d => !d)) { alert("Please ensure all 5 dates are selected."); return; }
    
    document.getElementById('statusMsg').textContent = "Fetching...";
    
    const rows = document.querySelectorAll('#tableBody tr');
    for (const tr of rows) {
        const ticker = tr.querySelector('.ticker-input').value.toUpperCase().replace(/\s/g, '');
        if (!ticker) continue;
        
        tr.style.backgroundColor = "#f0f8ff";
        try {
            await fetchAndFillRow(tr, ticker, dates);
        } catch (e) { console.warn(e); }
        tr.style.backgroundColor = "";
        calcRow(tr.id.split('-')[1]);
        await new Promise(r => setTimeout(r, 150));
    }
    document.getElementById('statusMsg').textContent = "Done.";
}

async function fetchAndFillRow(tr, ticker, dates) {
    // 1. Fetch Price History (20y to cover everything)
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=20y&events=div|split`;
    const res = await fetch(`https://corsproxy.io/?` + encodeURIComponent(url));
    if (!res.ok) return;
    const json = await res.json();
    const result = json.chart.result?.[0];
    if (!result) return;

    const timestamps = result.timestamp || [];
    const quotes = result.indicators.quote[0].close || [];
    const adjQuotes = result.indicators.adjclose?.[0].adjclose || quotes; // Prefer Adjusted Close if available

    // Helper: Find price closest to target date
    const findPrice = (dateStr) => {
        const target = dayjs(dateStr).unix();
        let closest = null;
        let minDiff = Infinity;
        // Search backwards
        for (let i = timestamps.length - 1; i >= 0; i--) {
            const diff = Math.abs(timestamps[i] - target);
            if (diff < 604800) { // Within 7 days
                if (diff < minDiff && adjQuotes[i] != null) {
                    minDiff = diff;
                    closest = adjQuotes[i];
                }
            }
            if (timestamps[i] < target - 700000) break;
        }
        return closest;
    };

    // Fill the 5 price slots
    dates.forEach((d, idx) => {
        const price = findPrice(d);
        if (price) {
            const el = tr.querySelector(`.p${idx}`);
            el.value = price.toFixed(2);
            el.style.backgroundColor = "#d4edda";
            setTimeout(() => el.style.backgroundColor = "", 1000);
        }
    });

    // 2. Sum Dividends between Start (date0) and End (date4)
    const divs = result.events?.dividends || {};
    let totalDivs = 0;
    const startTs = dayjs(dates[0]).unix();
    const endTs = dayjs(dates[4]).unix();
    
    Object.values(divs).forEach(d => {
        if (d.date >= startTs && d.date <= endTs) totalDivs += d.amount;
    });
    tr.dataset.divPerShare = totalDivs;
}

// --- CSV ---
function handleFileSelect(e) {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const lines = e.target.result.split(/\r\n|\n/);
        lines.forEach(line => {
            if(!line.trim()) return;
            const p = line.split(',');
            // Basic support for Ticker,Shares format
            const ticker = p[0].replace(/"/g,'').toUpperCase();
            const shares = parseFloat(p[1]?.replace(/"/g,''));
            if(ticker && !isNaN(shares)) addRow(ticker, shares);
        });
        calculateAll();
    };
    reader.readAsText(file);
}

function downloadCSV() {
    const rows = Array.from(document.querySelectorAll('#tableBody tr'));
    let csv = "Ticker,Shares,Price0,Val0,Price1,Val1,Price2,Val2,Price3,Val3,Price4,Val4,TotalDivs,Gain,Pct\n";
    rows.forEach(tr => {
        const t = tr.querySelector('.ticker-input').value;
        const s = tr.querySelector('.num-input').value;
        // Collect prices/values
        const p = [0,1,2,3,4].map(i => tr.querySelector(`.p${i}`).value).join(",");
        const v = [0,1,2,3,4].map(i => tr.querySelector(`.v${i}`).textContent.replace(/[$,]/g,'')).join(",");
        const d = tr.querySelector('.div-val').textContent.replace(/[$,]/g,'');
        const g = tr.querySelector('.gain-val').textContent.replace(/[$,+]/g,'');
        const pct = tr.querySelector('.pct-val').textContent.replace('%','');
        csv += `${t},${s},${p},${v},${d},${g},${pct}\n`;
    });
    
    // Add AI text
    const aiText = document.getElementById('ai-response-content').innerText;
    if(aiText) csv += `\n"AI ANALYSIS"\n"${aiText.replace(/"/g, '""')}"`;

    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "portfolio_timeline.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// --- AI ---
async function analyzePortfolio() {
    const apiKey = document.getElementById('geminiKey').value || "";
    if(!apiKey) { if(!confirm("No Gemini Key. Proceed using environment?")) return; }
    
    document.getElementById('ai-response-area').style.display = 'block';
    document.getElementById('ai-response-content').innerHTML = "Analyzing...";
    
    const sums = [0,1,2,3,4].map(i => document.getElementById(`sumVal${i}`).textContent);
    const gain = document.getElementById('sumTotalGain').textContent;
    
    const prompt = `Analyze this portfolio timeline:
    Start Value: ${sums[0]}
    Year 1 Value: ${sums[1]}
    Year 2 Value: ${sums[2]}
    Year 3 Value: ${sums[3]}
    End Value: ${sums[4]}
    Total Gain: ${gain}
    
    Provide a concise commentary on the growth trend year-over-year. Identify if growth is accelerating or decelerating.`;

    try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const json = await res.json();
        document.getElementById('ai-response-content').innerHTML = marked.parse(json.candidates[0].content.parts[0].text);
    } catch(e) {
        document.getElementById('ai-response-content').textContent = "Error: " + e.message;
    }
}
</script>
</body>
</html>
