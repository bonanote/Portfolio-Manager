<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Portfolio Return Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background: #f0f4f8; color: #333; }
  h1 { text-align: center; color: #1a1a1a; margin-bottom: 5px; }
  .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 0.9em; }

  /* Main Layout */
  .container { max-width: 1450px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

  /* Global Controls */
  .global-controls { display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; flex-wrap: wrap; }
  .control-group { display: flex; flex-direction: column; gap: 5px; }
  .control-group label { font-size: 12px; font-weight: 700; color: #666; text-transform: uppercase; }
  
  /* Table */
  .table-wrapper { overflow-x: auto; margin-bottom: 20px; }
  table { width: 100%; border-collapse: collapse; min-width: 1300px; }
  
  th { 
    text-align: left; 
    font-size: 12px; 
    color: #555; 
    text-transform: uppercase; 
    padding: 10px 8px; 
    border-bottom: 2px solid #eee; 
    white-space: nowrap; 
    user-select: none;
  }
  
  /* Sortable Headers */
  th.sortable { cursor: pointer; transition: background 0.1s; }
  th.sortable:hover { background-color: #f1f3f5; color: #007bff; }
  th.sortable::after { content: ' â†•'; font-size: 10px; color: #ccc; margin-left: 4px; }
  th.sortable.asc::after { content: ' â†‘'; color: #007bff; }
  th.sortable.desc::after { content: ' â†“'; color: #007bff; }

  td { padding: 8px; border-bottom: 1px solid #f1f1f1; vertical-align: top; }
  
  /* Inputs in Table */
  input { padding: 8px; border: 1px solid #dfe3e8; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; transition: border 0.2s; }
  input:focus { border-color: #007bff; outline: none; background: #f9fbff; }
  
  .ticker-input { text-transform: uppercase; font-weight: bold; width: 70px; }
  .date-input { width: 130px; }
  .num-input { width: 90px; }
  .price-input { width: 90px; font-weight: 500; }
  
  /* Read-only Calculations */
  .calc-val { padding: 8px; font-size: 14px; font-weight: 500; min-width: 80px; display: block; }
  .gain-val { font-weight: 700; }
  .div-val { color: #28a745; font-size: 13px; }
  .div-growth { font-size: 12px; color: #666; }

  /* Buttons */
  .btn { padding: 10px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
  .btn-sm { padding: 6px 10px; font-size: 12px; }
  .btn-primary { background: #007bff; color: white; }
  .btn-secondary { background: #6c757d; color: white; }
  .btn-magic { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .btn-ai { background: linear-gradient(135deg, #FF4B91 0%, #FF90BC 100%); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 6px; justify-content: center;}
  .btn-csv { background: #28a745; color: white; }
  .btn-add { background: #e9ecef; color: #333; border: 1px solid #ced4da; }
  .btn-remove { background: transparent; color: #dc3545; border: 1px solid transparent; font-size: 18px; padding: 4px 8px; line-height: 1; }
  .btn:hover { opacity: 0.9; }
  .btn-remove:hover { background: #fee; border-color: #fcc; }

  /* Yahoo Link Button */
  .yahoo-link {
    display: flex; align-items: center; justify-content: center;
    background: #720e9e; color: white; text-decoration: none;
    font-size: 11px; font-weight: bold; width: 24px; height: 24px;
    border-radius: 4px; transition: background 0.2s;
  }
  .yahoo-link:hover { background: #500095; }

  /* Summary Section */
  .summary-panel { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
    gap: 15px; 
    margin-top: 20px; 
    padding-top: 20px; 
    border-top: 2px solid #eee; 
  }
  .summary-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
  .sum-label { font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 0.5px; }
  .sum-value { font-size: 20px; font-weight: 800; color: #333; }
  .sum-sub { font-size: 13px; font-weight: 600; margin-top: 4px; }
  .sum-sub-small { font-size: 11px; color: #666; margin-top: 4px; }
  
  .positive { color: #28a745; }
  .negative { color: #dc3545; }

  /* AI Panel */
  #ai-response-area {
    margin-top: 20px;
    padding: 20px;
    background: #fff0f6;
    border: 1px solid #ffc9e0;
    border-radius: 12px;
    display: none;
  }
  #ai-response-content { font-size: 15px; line-height: 1.6; color: #444; }
  #ai-response-content h2, #ai-response-content h3 { margin-top: 0; color: #d63384; }
  #ai-response-content strong { color: #333; }
  .ai-loading { color: #d63384; font-style: italic; animation: pulse 1.5s infinite; }
  
  @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

  /* Status Bar */
  #statusMsg { font-size: 13px; margin-left: auto; font-weight: 500; }
</style>
</head>
<body>

<h1>Portfolio Return Analyzer</h1>
<div class="subtitle">Multi-Stock Tracker â€¢ Dividends Included â€¢ Historical Comparisons</div>

<div class="container">

  <!-- Global Settings -->
  <div class="global-controls">
    
    <!-- New: Global Start Date -->
    <div class="control-group">
      <label>Global Start Date</label>
      <div style="display:flex; gap:5px;">
        <input type="date" id="globalStartDate" class="date-input" style="width:140px;">
        <button class="btn btn-secondary btn-sm" onclick="applyGlobalStart()" title="Set this date for all stocks">Apply to All</button>
      </div>
    </div>

    <!-- Existing: Global End Date -->
    <div class="control-group">
      <label>Valuation Date (End Date)</label>
      <input type="date" id="globalEndDate" class="date-input" style="width:160px;">
    </div>
    
    <div class="control-group" style="flex:1;">
       <label>Actions</label>
       <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
         <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)">
         <button class="btn btn-csv" onclick="document.getElementById('csvInput').click()">ðŸ“‚ Import CSV</button>
         <button class="btn btn-magic" onclick="fetchAllYahoo()">âœ¨ Fetch Prices & Divs</button>
         <button class="btn btn-primary" onclick="calculateAll()">Recalculate</button>
         <button class="btn btn-export" onclick="downloadCSV()">ðŸ“¥ Export Data (Full)</button>
         <div id="statusMsg"></div>
       </div>
    </div>
    
    <div style="font-size:12px;">
      <details>
        <summary style="cursor:pointer; color:#007bff;">API Settings (FMP & Gemini)</summary>
        <div style="position:absolute; background:white; padding:15px; border:1px solid #ccc; border-radius:6px; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-top:5px; right: 40px; width:300px; z-index: 20;">
           
           <div style="margin-bottom:10px;">
             <label>FMP Key (Stock Data)</label>
             <input type="text" id="apiKey" placeholder="FMP API Key" style="margin-top:2px;">
           </div>
           
           <div style="margin-bottom:10px;">
             <label>Gemini API Key (AI Analysis)</label>
             <input type="text" id="geminiKey" placeholder="Gemini API Key (Optional)" style="margin-top:2px;">
             <small style="color:#666; font-size:10px;">Leave empty if provided by environment.</small>
           </div>

           <button class="btn btn-primary btn-sm" style="width:100%;" onclick="saveKeys()">Save Keys</button>
        </div>
      </details>
    </div>
  </div>

  <!-- Main Table -->
  <div class="table-wrapper">
    <table id="pfTable">
      <thead>
        <tr>
          <th class="sortable" onclick="sortPortfolio('ticker')">Ticker</th>
          <th width="80">Shares</th>
          <th width="140">Start Date</th>
          <th width="100">Start Price</th>
          <th class="sortable" onclick="sortPortfolio('initial')">Initial Cost</th>
          <th width="100">End Price</th>
          <th class="sortable" onclick="sortPortfolio('final')">Mkt Value</th>
          <th class="sortable" onclick="sortPortfolio('dividends')">Total Divs</th>
          <th class="sortable" onclick="sortPortfolio('divGrowth')">Div Growth</th>
          <th class="sortable" onclick="sortPortfolio('capGrowth')">Price Growth</th>
          <th class="sortable" onclick="sortPortfolio('gain')">Total Gain</th>
          <th class="sortable" onclick="sortPortfolio('return')">Total Return</th>
          <th width="40"></th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Rows Generated Here -->
      </tbody>
    </table>
  </div>

  <button class="btn btn-add" onclick="addRow()">+ Add Stock</button>

  <!-- Summary Footer -->
  <div class="summary-panel">
    <div class="summary-card">
      <div class="sum-label">Cost Basis</div>
      <div class="sum-value" id="sumInitial">$0.00</div>
    </div>
    
    <div class="summary-card">
      <div class="sum-label">Market Value</div>
      <div class="sum-value" id="sumFinal">$0.00</div>
    </div>

    <!-- Breakdown: Capital Gains -->
    <div class="summary-card" style="background:#e8f4fd;">
      <div class="sum-label">Capital Gain (Price)</div>
      <div class="sum-value" id="sumCapGain">$0.00</div>
      <div class="sum-sub" id="sumCapPct">0.00%</div>
      <div class="sum-sub-small" id="sumCapCAGR" title="Annualized Price Growth">CAGR: 0.0%</div>
    </div>

    <!-- Breakdown: Dividends -->
    <div class="summary-card" style="background:#e6fffa;">
      <div class="sum-label">Dividend Income</div>
      <div class="sum-value" id="sumDivGain">$0.00</div>
      <div class="sum-sub" id="sumDivPct">0.00%</div>
      <div class="sum-sub-small" id="sumDivYield" title="Annualized Yield">Avg Yield: 0.0%</div>
      <div class="sum-sub-small" id="sumDivGrowth" style="color:#198754;" title="Weighted Average Dividend Growth">Avg Growth: 0.0%</div>
    </div>

    <!-- Total -->
    <div class="summary-card" style="background:#e3f2fd; border:1px solid #b6d4fe;">
      <div class="sum-label">Total Return (All)</div>
      <div class="sum-value" id="sumTotalGain">$0.00</div>
      <div class="sum-sub" id="sumTotalPct">0.00%</div>
      <div class="sum-sub-small" id="sumCAGR" style="font-weight:bold; color:#007bff;">Total CAGR: 0.0%</div>
      <div class="sum-sub-small" id="sumTotalDuration" style="color:#666; font-size:11px; margin-top:2px;">Avg Period: 0y 0m</div>
    </div>
    
    <!-- AI Analysis Button -->
    <div class="summary-card" style="background:#fff0f6; cursor:pointer; border:1px solid #ffc9e0;" onclick="analyzePortfolio()">
        <div class="sum-label" style="color:#d63384;">AI Insights</div>
        <div style="font-weight:bold; color:#d63384; display:flex; align-items:center; justify-content:center; gap:5px; margin-top:5px;">
            <span>âœ¨ Analyze</span>
        </div>
    </div>
  </div>

  <!-- AI Response Container -->
  <div id="ai-response-area">
      <div id="ai-response-content"></div>
  </div>

</div>

<script>
// --- STATE ---
let rowCount = 0;
let currentSort = { column: null, direction: 'asc' };
const defaultTickers = ['AAPL', 'MSFT', 'GOOGL', 'BTI', 'MO'];

// --- INIT ---
document.getElementById('globalEndDate').value = dayjs().format("YYYY-MM-DD");
document.getElementById('globalStartDate').value = dayjs().subtract(1, 'year').format("YYYY-MM-DD");

// Load Keys
const savedFMPKey = localStorage.getItem('fmp_key');
if(savedFMPKey) document.getElementById('apiKey').value = savedFMPKey;

const savedGeminiKey = localStorage.getItem('gemini_key');
if(savedGeminiKey) document.getElementById('geminiKey').value = savedGeminiKey;

defaultTickers.forEach(t => addRow(t));

// --- FUNCTIONS ---

function saveKeys() {
    localStorage.setItem('fmp_key', document.getElementById('apiKey').value.trim());
    localStorage.setItem('gemini_key', document.getElementById('geminiKey').value.trim());
    alert("API Keys Saved");
}

function updateYahooLink(id) {
    const row = document.getElementById(`row-${id}`);
    const input = row.querySelector('.ticker-input');
    let val = input.value.toUpperCase().replace(/\s/g, '');
    if(input.value !== val) input.value = val;
    
    const link = row.querySelector('.yahoo-link');
    if(val) {
        link.href = `https://finance.yahoo.com/quote/${val}`;
        link.style.display = 'flex';
    } else {
        link.style.display = 'none';
    }
}

function applyGlobalStart() {
    const globalDate = document.getElementById('globalStartDate').value;
    if(!globalDate) return;
    
    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(tr => {
        tr.querySelector('.start-date').value = globalDate;
        const dateInput = tr.querySelector('.start-date');
        dateInput.style.backgroundColor = "#e2e6ea";
        setTimeout(() => dateInput.style.backgroundColor = "", 500);
    });
}

function addRow(ticker = '', initialShares = 10) {
    rowCount++;
    const tbody = document.getElementById('tableBody');
    const tr = document.createElement('tr');
    tr.id = `row-${rowCount}`;
    tr.dataset.divPerShare = "0"; 
    tr.dataset.divGrowth = "0"; 
    tr.dataset.capGrowth = "0"; // Store Cap CAGR
    
    ticker = ticker.toUpperCase().replace(/\s/g, '');
    let startDateVal = document.getElementById('globalStartDate').value;
    if(!startDateVal) startDateVal = dayjs().subtract(1, 'year').format("YYYY-MM-DD");

    tr.innerHTML = `
      <td>
        <div style="display:flex; align-items:center; gap:6px;">
          <input type="text" class="ticker-input" value="${ticker}" placeholder="SYM" 
                 oninput="updateYahooLink(${rowCount})">
          <a href="https://finance.yahoo.com/quote/${ticker}" target="_blank" class="yahoo-link" title="Open Yahoo Finance">Y!</a>
        </div>
      </td>
      <td><input type="number" class="num-input" value="${initialShares}" step="any" oninput="calcRow(${rowCount})"></td>
      <td><input type="date" class="date-input start-date" value="${startDateVal}" onchange="calcRow(${rowCount})"></td>
      <td><input type="number" class="price-input start-price" placeholder="0.00" step="0.01" oninput="calcRow(${rowCount})"></td>
      <td><span class="calc-val val-initial">$0.00</span></td>
      <td><input type="number" class="price-input end-price" placeholder="0.00" step="0.01" oninput="calcRow(${rowCount})"></td>
      <td><span class="calc-val val-final">$0.00</span></td>
      <td><span class="calc-val div-val" title="Total cash dividends collected">$0.00</span></td>
      <td><span class="calc-val growth-val div-growth">-</span></td>
      <td><span class="calc-val growth-val cap-growth">-</span></td>
      <td><span class="calc-val gain-val" style="color:#ccc;">$0.00</span></td>
      <td><span class="calc-val pct-val" style="color:#ccc;">0%</span></td>
      <td><button class="btn btn-remove" onclick="removeRow(${rowCount})">&times;</button></td>
    `;
    tbody.appendChild(tr);
    calcRow(rowCount);
}

function removeRow(id) {
    const row = document.getElementById(`row-${id}`);
    if(row) row.remove();
    calculateAll();
}

// --- SORTING LOGIC ---
function sortPortfolio(column) {
    const tbody = document.getElementById('tableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = (column === 'ticker') ? 'asc' : 'desc';
    }

    rows.sort((a, b) => {
        let valA, valB;
        if (column === 'ticker') {
            valA = a.querySelector('.ticker-input').value.toUpperCase();
            valB = b.querySelector('.ticker-input').value.toUpperCase();
            return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        } else {
            if (column === 'initial') valA = parseMoney(a.querySelector('.val-initial').textContent);
            else if (column === 'final') valA = parseMoney(a.querySelector('.val-final').textContent);
            else if (column === 'dividends') valA = parseMoney(a.querySelector('.div-val').textContent);
            else if (column === 'divGrowth') valA = parseFloat(a.dataset.divGrowth) || 0;
            else if (column === 'capGrowth') valA = parseFloat(a.dataset.capGrowth) || 0;
            else if (column === 'gain') valA = parseMoney(a.querySelector('.gain-val').textContent);
            else if (column === 'return') valA = parseFloat(a.querySelector('.pct-val').textContent);
            
            if (column === 'initial') valB = parseMoney(b.querySelector('.val-initial').textContent);
            else if (column === 'final') valB = parseMoney(b.querySelector('.val-final').textContent);
            else if (column === 'dividends') valB = parseMoney(b.querySelector('.div-val').textContent);
            else if (column === 'divGrowth') valB = parseFloat(b.dataset.divGrowth) || 0;
            else if (column === 'capGrowth') valB = parseFloat(b.dataset.capGrowth) || 0;
            else if (column === 'gain') valB = parseMoney(b.querySelector('.gain-val').textContent);
            else if (column === 'return') valB = parseFloat(b.querySelector('.pct-val').textContent);

            return currentSort.direction === 'asc' ? valA - valB : valB - valA;
        }
    });

    rows.forEach(row => tbody.appendChild(row));

    document.querySelectorAll('th.sortable').forEach(th => { th.classList.remove('asc', 'desc'); });
    const targetTh = Array.from(document.querySelectorAll('th.sortable')).find(th => 
        th.getAttribute('onclick').includes(`'${column}'`)
    );
    if(targetTh) targetTh.classList.add(currentSort.direction);
}

function parseMoney(str) {
    return parseFloat(str.replace(/[^0-9.-]/g, '')) || 0;
}

// --- CSV IMPORT ---
function handleFileSelect(evt) {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) { processCSV(e.target.result); evt.target.value = ''; };
    reader.readAsText(file);
}

function processCSV(text) {
    const lines = text.split(/\r\n|\n/);
    let addedCount = 0;
    lines.forEach(line => {
        if (!line.trim()) return;
        const parts = parseCSVLine(line);
        if(parts.length < 2) return;
        
        const ticker = parts[0].trim().replace(/^"|"$/g, '').toUpperCase().replace(/\s/g, '');
        if(ticker.includes("TICKER")) return;
        
        let sharesStr = parts[1].trim().replace(/^"|"$/g, '').replace(/,/g, ''); 
        const shares = parseFloat(sharesStr);
        if (ticker && !isNaN(shares)) { addRow(ticker, shares); addedCount++; }
    });
    if(addedCount > 0) {
        document.getElementById('statusMsg').textContent = `Imported ${addedCount} stocks.`;
        document.getElementById('statusMsg').style.color = "green";
        calculateAll();
    } else { alert("No valid stock data found in CSV."); }
}

function parseCSVLine(text) {
    const result = [];
    let current = '';
    let inQuote = false;
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === '"') inQuote = !inQuote;
        else if (char === ',' && !inQuote) { result.push(current); current = ''; } 
        else current += char;
    }
    result.push(current);
    return result;
}

// --- CSV EXPORT (FULL) ---
function downloadCSV() {
    const rows = Array.from(document.querySelectorAll('#tableBody tr'));
    if (rows.length === 0) { alert("No data to export"); return; }

    // 1. Portfolio Holdings Table
    let csvContent = "PORTFOLIO HOLDINGS\n";
    const headers = [
        "Ticker", "Shares", "Start Date", "Start Price", "Initial Cost", 
        "End Price", "Final Value", "Total Dividends", "Div Growth %", 
        "Price Growth %", "Total Gain", "Total Return %"
    ];
    csvContent += headers.join(",") + "\n";

    rows.forEach(tr => {
        const rowData = [
            `"${tr.querySelector('.ticker-input').value}"`, 
            tr.querySelector('.num-input').value,
            tr.querySelector('.start-date').value,
            tr.querySelector('.start-price').value,
            tr.querySelector('.val-initial').textContent.replace(/[$,]/g, ''),
            tr.querySelector('.end-price').value,
            tr.querySelector('.val-final').textContent.replace(/[$,]/g, ''),
            tr.querySelector('.div-val').textContent.replace(/[$,]/g, ''),
            tr.dataset.divGrowth || 0,
            tr.dataset.capGrowth || 0,
            tr.querySelector('.gain-val').textContent.replace(/[$,+]/g, ''),
            tr.querySelector('.pct-val').textContent.replace(/%/g, '')
        ];
        csvContent += rowData.join(",") + "\n";
    });

    // 2. Portfolio Summary Section
    csvContent += "\nPORTFOLIO SUMMARY\n";
    csvContent += "Metric,Value,Rate/Pct,Additional Info\n";
    
    const clean = (id) => document.getElementById(id)?.textContent.replace(/[$,+]/g, '').trim() || "0";
    
    csvContent += `Cost Basis,${clean('sumInitial')},,\n`;
    csvContent += `Market Value,${clean('sumFinal')},,\n`;
    csvContent += `Capital Gain,${clean('sumCapGain')},${clean('sumCapPct')},${clean('sumCapCAGR')}\n`;
    csvContent += `Dividend Income,${clean('sumDivGain')},${clean('sumDivPct')},"${clean('sumDivYield')} | ${clean('sumDivGrowth')}"\n`;
    csvContent += `Total Return,${clean('sumTotalGain')},${clean('sumTotalPct')},${clean('sumCAGR')}\n`;
    csvContent += `Avg Duration,,,${clean('sumTotalDuration')}\n`;

    // 3. AI Analysis Section (if present)
    const aiText = document.getElementById('ai-response-content').innerText;
    if (aiText && !aiText.includes("Analyzing...")) {
        csvContent += "\nAI FINANCIAL ANALYSIS\n";
        // Escape existing quotes by doubling them, wrap content in quotes to handle newlines
        const safeText = `"${aiText.replace(/"/g, '""')}"`;
        csvContent += safeText + "\n";
    }

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `portfolio_full_report_${dayjs().format('YYYY-MM-DD')}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- CALCULATION ---
function calcRow(id) {
    const row = document.getElementById(`row-${id}`);
    if(!row) return;

    const shares = parseFloat(row.querySelector('.num-input').value) || 0;
    const startPrice = parseFloat(row.querySelector('.start-price').value) || 0;
    const endPrice = parseFloat(row.querySelector('.end-price').value) || 0;
    const startDate = row.querySelector('.start-date').value;
    const divPerShare = parseFloat(row.dataset.divPerShare) || 0;
    const divGrowth = parseFloat(row.dataset.divGrowth) || 0;

    const initialVal = shares * startPrice;
    const finalVal = shares * endPrice;
    const totalDividends = shares * divPerShare;
    
    // Total Gain = (Final Value + Dividends) - Initial Cost
    const totalGain = (finalVal + totalDividends) - initialVal;
    const pct = initialVal > 0 ? (totalGain / initialVal) * 100 : 0;

    // Calculate Capital CAGR
    let capGrowth = 0;
    if (startDate && startPrice > 0 && endPrice > 0) {
        const endDateStr = document.getElementById('globalEndDate').value;
        const years = dayjs(endDateStr).diff(dayjs(startDate), 'year', true);
        if (years > 0.01) {
            capGrowth = (Math.pow((endPrice / startPrice), (1 / years)) - 1) * 100;
        }
    }
    
    // Store calc
    row.dataset.capGrowth = capGrowth;

    row.querySelector('.val-initial').textContent = fmtMoney(initialVal);
    row.querySelector('.val-final').textContent = fmtMoney(finalVal);
    row.querySelector('.div-val').textContent = fmtMoney(totalDividends);
    
    // Display Dividend Growth
    const divGrowthEl = row.querySelector('.div-growth');
    if (divGrowth !== 0 && !isNaN(divGrowth)) {
        divGrowthEl.textContent = divGrowth.toFixed(1) + "%";
        divGrowthEl.style.color = divGrowth >= 0 ? "#198754" : "#dc3545";
    } else {
        divGrowthEl.textContent = "-";
        divGrowthEl.style.color = "#666";
    }

    // Display Capital Growth
    const capGrowthEl = row.querySelector('.cap-growth');
    if (capGrowth !== 0 && !isNaN(capGrowth)) {
        capGrowthEl.textContent = capGrowth.toFixed(1) + "%";
        capGrowthEl.style.color = capGrowth >= 0 ? "#198754" : "#dc3545";
    } else {
        capGrowthEl.textContent = "-";
        capGrowthEl.style.color = "#666";
    }
    
    const gainEl = row.querySelector('.gain-val');
    gainEl.textContent = (totalGain >= 0 ? "+" : "") + fmtMoney(totalGain);
    gainEl.className = "calc-val gain-val " + (totalGain >= 0 ? "positive" : "negative");

    const pctEl = row.querySelector('.pct-val');
    pctEl.textContent = pct.toFixed(2) + "%";
    pctEl.className = "calc-val pct-val " + (totalGain >= 0 ? "positive" : "negative");

    updateSummary();
}

function calculateAll() {
    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(tr => {
        const id = tr.id.split('-')[1];
        calcRow(id);
    });
}

function updateSummary() {
    let totalInitial = 0;
    let totalMarketVal = 0; 
    let totalDividends = 0;
    let weightedTimeAccumulator = 0;
    let weightedDivGrowthAccumulator = 0;
    let totalMarketValWithDivGrowth = 0; 
    
    const globalEndDateStr = document.getElementById('globalEndDate').value;
    const globalEndDate = dayjs(globalEndDateStr);

    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(tr => {
        const shares = parseFloat(tr.querySelector('.num-input').value) || 0;
        const sP = parseFloat(tr.querySelector('.start-price').value) || 0;
        const eP = parseFloat(tr.querySelector('.end-price').value) || 0;
        const dPS = parseFloat(tr.dataset.divPerShare) || 0;
        const divGrowth = parseFloat(tr.dataset.divGrowth) || 0;
        
        const initial = shares * sP;
        const final = shares * eP;
        const divs = shares * dPS;
        
        totalInitial += initial;
        totalMarketVal += final;
        totalDividends += divs;
        
        const rowStartDateVal = tr.querySelector('.start-date').value;
        if(rowStartDateVal && globalEndDateStr && initial > 0) {
            const sDate = dayjs(rowStartDateVal);
            const diffDays = globalEndDate.diff(sDate, 'day');
            const years = diffDays / 365.25;
            weightedTimeAccumulator += (initial * years);
        }
        
        if(final > 0 && !isNaN(divGrowth) && divGrowth !== 0) {
            weightedDivGrowthAccumulator += (divGrowth * final);
            totalMarketValWithDivGrowth += final;
        }
    });

    // Breakdown Calculations
    const capitalGain = totalMarketVal - totalInitial;
    const totalGain = capitalGain + totalDividends;
    
    // Percentages
    const capReturnPct = totalInitial > 0 ? (capitalGain / totalInitial) * 100 : 0;
    const divReturnPct = totalInitial > 0 ? (totalDividends / totalInitial) * 100 : 0;
    const totalReturnPct = totalInitial > 0 ? (totalGain / totalInitial) * 100 : 0;

    // Time-Weighted Averages
    const avgYears = totalInitial > 0 ? weightedTimeAccumulator / totalInitial : 0;
    
    // Format Duration
    const yearsInt = Math.floor(avgYears);
    const monthsInt = Math.round((avgYears - yearsInt) * 12);
    const durationText = `${yearsInt}y ${monthsInt}m`;

    // 1. Capital CAGR
    let capCAGR = 0;
    if(totalInitial > 0 && totalMarketVal > 0 && avgYears > 0.01) {
        capCAGR = (Math.pow((totalMarketVal / totalInitial), (1 / avgYears)) - 1) * 100;
    } else if (totalInitial > 0 && avgYears <= 0.01) {
        capCAGR = capReturnPct;
    }

    // 2. Dividend Annualized Yield
    let divAnn = 0;
    if(totalInitial > 0 && avgYears > 0.01) {
        divAnn = divReturnPct / avgYears;
    } else if (totalInitial > 0 && avgYears <= 0.01) {
        divAnn = divReturnPct;
    }
    
    // 3. Portfolio Avg Dividend Growth
    const avgDivGrowth = totalMarketValWithDivGrowth > 0 ? (weightedDivGrowthAccumulator / totalMarketValWithDivGrowth) : 0;

    // 4. Total CAGR
    let totalCAGR = 0;
    const totalEndValue = totalMarketVal + totalDividends;
    
    if(totalInitial > 0 && totalEndValue > 0 && avgYears > 0.01) {
        totalCAGR = (Math.pow((totalEndValue / totalInitial), (1 / avgYears)) - 1) * 100;
    } else if (totalInitial > 0 && avgYears <= 0.01) {
        totalCAGR = totalReturnPct; 
    }

    // UI Updates
    document.getElementById('sumInitial').textContent = fmtMoney(totalInitial);
    document.getElementById('sumFinal').textContent = fmtMoney(totalMarketVal);
    
    // Capital Gains
    const capGainEl = document.getElementById('sumCapGain');
    capGainEl.textContent = (capitalGain >= 0 ? "+" : "") + fmtMoney(capitalGain);
    capGainEl.className = "sum-value " + (capitalGain >= 0 ? "positive" : "negative");
    document.getElementById('sumCapPct').textContent = capReturnPct.toFixed(2) + "%";
    document.getElementById('sumCapPct').className = "sum-sub " + (capReturnPct >= 0 ? "positive" : "negative");
    document.getElementById('sumCapCAGR').textContent = "CAGR: " + capCAGR.toFixed(2) + "%";

    // Dividends
    const divGainEl = document.getElementById('sumDivGain');
    divGainEl.textContent = "+" + fmtMoney(totalDividends);
    divGainEl.className = "sum-value positive";
    document.getElementById('sumDivPct').textContent = divReturnPct.toFixed(2) + "%";
    document.getElementById('sumDivPct').className = "sum-sub positive";
    document.getElementById('sumDivYield').textContent = "Avg Yield: " + divAnn.toFixed(2) + "%";
    
    const divGrowthEl = document.getElementById('sumDivGrowth');
    divGrowthEl.textContent = "Avg Growth: " + avgDivGrowth.toFixed(1) + "%";
    divGrowthEl.style.color = avgDivGrowth >= 0 ? "#198754" : "#dc3545";

    // Total Return
    const totalGainEl = document.getElementById('sumTotalGain');
    totalGainEl.textContent = (totalGain >= 0 ? "+" : "") + fmtMoney(totalGain);
    totalGainEl.className = "sum-value " + (totalGain >= 0 ? "positive" : "negative");
    document.getElementById('sumTotalPct').textContent = totalReturnPct.toFixed(2) + "%";
    document.getElementById('sumTotalPct').className = "sum-sub " + (totalReturnPct >= 0 ? "positive" : "negative");
    
    const cagrEl = document.getElementById('sumCAGR');
    cagrEl.textContent = "Total CAGR: " + totalCAGR.toFixed(2) + "%";
    cagrEl.className = "sum-sub-small " + (totalCAGR >= 0 ? "positive" : "negative");
    cagrEl.style.fontWeight = "bold";
    cagrEl.style.fontSize = "13px";
    
    // Added Duration
    document.getElementById('sumTotalDuration').textContent = "Avg Period: " + durationText;
}

function fmtMoney(n) {
    return "$" + n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// --- FETCH LOGIC ---

async function fetchAllYahoo() {
    const rows = document.querySelectorAll('#tableBody tr');
    const endDate = document.getElementById('globalEndDate').value;
    const status = document.getElementById('statusMsg');

    if(!endDate) { alert("Please select a Valuation Date (End Date)"); return; }

    status.textContent = "Fetching...";
    status.style.color = "blue";

    for (const tr of rows) {
        const ticker = tr.querySelector('.ticker-input').value.toUpperCase().replace(/\s/g, ''); 
        if(!ticker) continue;
        const startDate = tr.querySelector('.start-date').value;
        const id = tr.id.split('-')[1];

        tr.style.backgroundColor = "#f0f8ff";
        try {
            await fetchRowYahooAdaptive(tr, ticker, startDate, endDate);
        } catch(err) { console.error(`Failed ${ticker}:`, err); }
        tr.style.backgroundColor = "";
        calcRow(id);
        await new Promise(r => setTimeout(r, 200)); 
    }
    status.textContent = "Done!";
    status.style.color = "green";
    setTimeout(() => status.textContent = "", 3000);
}

// Adaptive Strategy
async function fetchRowYahooAdaptive(tr, ticker, d1, d2) {
    const ranges = ['20y', '10y', '5y', '2y'];
    
    const tryFetch = async (range) => {
        // Query string includes events=div|split to ensure dividends are returned
        const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=${range}&events=div|split`;
        const proxyUrl = `https://corsproxy.io/?` + encodeURIComponent(targetUrl);
        const res = await fetch(proxyUrl);
        if(!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();
        const result = json.chart.result?.[0];
        if(!result) throw new Error("No Data");
        return result;
    };

    let result = null;
    for (const range of ranges) {
        try { result = await tryFetch(range); break; } 
        catch (e) { console.warn(`Fetch ${ticker} failed for ${range}, trying shorter...`); }
    }

    if (!result) {
        tr.querySelector('.ticker-input').style.borderColor = "red";
        return; 
    } else {
        tr.querySelector('.ticker-input').style.borderColor = "";
    }

    const timestamps = result.timestamp || [];
    const quotes = result.indicators.quote[0].close || [];
    
    // --- DIVIDEND LOGIC ---
    const dividendsObj = result.events ? result.events.dividends : {};
    let totalDividendsPerShare = 0;
    
    // Parse times
    const startTs = d1 ? dayjs(d1).unix() : 0;
    const endTs = d2 ? dayjs(d2).unix() : Infinity;
    const startPlusOneYear = d1 ? dayjs(d1).add(1, 'year').unix() : 0;
    const endMinusOneYear = d2 ? dayjs(d2).subtract(1, 'year').unix() : 0;

    let divSumStart = 0; // First year
    let divSumEnd = 0;   // Last year
    let divCagr = 0;

    if (dividendsObj) {
        Object.values(dividendsObj).forEach(div => {
            const dt = div.date;
            // Sum Total
            if (dt >= startTs && dt <= endTs) {
                totalDividendsPerShare += div.amount;
            }
            // Sum Start Rate (First 12 months)
            if (dt >= startTs && dt <= startPlusOneYear) {
                divSumStart += div.amount;
            }
            // Sum End Rate (Last 12 months)
            if (dt >= endMinusOneYear && dt <= endTs) {
                divSumEnd += div.amount;
            }
        });
    }
    
    // Calculate Div CAGR
    // Only valid if we have > 2 years of data and non-zero dividends
    const yearsDiff = d1 && d2 ? dayjs(d2).diff(dayjs(d1), 'year', true) : 0;
    
    if (yearsDiff >= 2 && divSumStart > 0 && divSumEnd > 0) {
        // Formula: (EndRate / StartRate)^(1/(years-1)) - 1
        divCagr = (Math.pow((divSumEnd / divSumStart), (1 / (yearsDiff - 1))) - 1) * 100;
    }

    // Store data
    tr.dataset.divPerShare = totalDividendsPerShare;
    tr.dataset.divGrowth = divCagr;

    // --- PRICE LOGIC ---
    const findPrice = (dateStr) => {
        if(!dateStr) return null;
        const targetTime = dayjs(dateStr).unix();
        let closestPrice = null;
        let minDiff = Infinity;
        
        for(let i = timestamps.length - 1; i >= 0; i--) {
            const diff = Math.abs(timestamps[i] - targetTime);
            if(diff < 1209600) { // 14 days
                if(diff < minDiff && quotes[i] != null) {
                    minDiff = diff;
                    closestPrice = quotes[i];
                }
            }
            if(timestamps[i] < targetTime - 1300000) break;
        }
        return closestPrice;
    };

    const markError = (el) => {
        el.style.backgroundColor = "#f8d7da"; el.style.borderColor = "#dc3545"; el.title = "Data unavailable";
    };
    const markSuccess = (el) => {
        el.style.backgroundColor = ""; el.style.borderColor = ""; el.title = ""; flash(el);
    };

    if(d1) {
        const p1 = findPrice(d1);
        const el = tr.querySelector('.start-price');
        if(p1) { el.value = p1.toFixed(2); markSuccess(el); } else { markError(el); }
    }

    if(d2) {
        const p2 = findPrice(d2);
        const el = tr.querySelector('.end-price');
        if(p2) { el.value = p2.toFixed(2); markSuccess(el); } else { markError(el); }
    }
}

function flash(el) {
    el.style.backgroundColor = "#d4edda";
    setTimeout(() => el.style.backgroundColor = "", 1000);
}

// --- GEMINI AI INTEGRATION ---

async function analyzePortfolio() {
    const aiKeyInput = document.getElementById('geminiKey').value.trim();
    // Use user input key OR empty string (environment will handle if configured)
    const apiKey = aiKeyInput || "";
    
    if(!apiKey) {
        // Just a friendly prompt if they haven't set one, but proceed in case env works
        const proceed = confirm("No Gemini API Key entered. If you are in a preview environment with a built-in key, click OK. Otherwise, Cancel and enter a key in Settings.");
        if(!proceed) return;
    }

    const aiDiv = document.getElementById('ai-response-area');
    const contentDiv = document.getElementById('ai-response-content');
    
    aiDiv.style.display = 'block';
    contentDiv.innerHTML = '<div class="ai-loading">âœ¨ Analyzing...</div>';
    
    // 1. Gather Data
    const rows = Array.from(document.querySelectorAll('#tableBody tr')).map(tr => {
        return {
            ticker: tr.querySelector('.ticker-input').value,
            shares: tr.querySelector('.num-input').value,
            dividends: tr.querySelector('.div-val').textContent,
            divGrowth: tr.querySelector('.div-growth').textContent,
            gain: tr.querySelector('.gain-val').textContent,
            returnPct: tr.querySelector('.pct-val').textContent
        };
    }).filter(r => r.ticker);

    const summary = {
        capGain: document.getElementById('sumCapGain')?.textContent || "N/A",
        capPct: document.getElementById('sumCapPct')?.textContent || "N/A",
        capCAGR: document.getElementById('sumCapCAGR')?.textContent || "N/A",
        divGain: document.getElementById('sumDivGain')?.textContent || "N/A",
        divPct: document.getElementById('sumDivPct')?.textContent || "N/A",
        divAnn: document.getElementById('sumDivYield')?.textContent || "N/A",
        divGrowth: document.getElementById('sumDivGrowth')?.textContent || "N/A",
        totalGain: document.getElementById('sumTotalGain')?.textContent || "N/A",
        totalPct: document.getElementById('sumTotalPct')?.textContent || "N/A",
        cagr: document.getElementById('sumCAGR')?.textContent || "N/A"
    };

    // 2. Construct Prompt
    const promptText = `
    You are a professional financial analyst. Analyze the following portfolio:
    
    **Performance Breakdown:**
    - Capital Appreciation: ${summary.capGain} (${summary.capPct}) | ${summary.capCAGR}
    - Dividend Income: ${summary.divGain} (${summary.divPct}) | ${summary.divAnn} | ${summary.divGrowth}
    - Total Return: ${summary.totalGain} (${summary.totalPct})
    - ${summary.cagr}

    **Holdings:**
    ${rows.map(r => `- ${r.ticker}: Total Return ${r.returnPct} (Divs: ${r.dividends}, Div Growth: ${r.divGrowth}, Total Gain: ${r.gain})`).join('\n')}

    **Instructions:**
    1. Executive Summary: Comment on the balance between growth (capital gains) and income (dividends).
    2. Comment specifically on the Dividend Growth Rate (is income growing?).
    3. Best/Worst Performers.
    4. Risk/Sector Analysis.
    5. Keep it under 250 words. Professional tone.
    `;

    // 3. Call Gemini API
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: promptText }] }]
            })
        });

        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        
        const data = await response.json();
        const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (rawText) {
            contentDiv.innerHTML = marked.parse(rawText);
        } else {
            throw new Error("No response text generated.");
        }

    } catch (err) {
        console.error("Gemini Error:", err);
        contentDiv.innerHTML = `<span style="color:red;">Error: ${err.message}</span>`;
    }
}
</script>
</body>
</html>
