<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Portfolio Return Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background: #f0f4f8; color: #333; }
  h1 { text-align: center; color: #1a1a1a; margin-bottom: 5px; }
  .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 0.9em; }

  /* Main Layout */
  .container { max-width: 1250px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

  /* Global Controls */
  .global-controls { display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; flex-wrap: wrap; }
  .control-group { display: flex; flex-direction: column; gap: 5px; }
  .control-group label { font-size: 12px; font-weight: 700; color: #666; text-transform: uppercase; }
  
  /* Table */
  .table-wrapper { overflow-x: auto; margin-bottom: 20px; }
  table { width: 100%; border-collapse: collapse; min-width: 1100px; }
  
  th { 
    text-align: left; 
    font-size: 12px; 
    color: #555; 
    text-transform: uppercase; 
    padding: 10px 8px; 
    border-bottom: 2px solid #eee; 
    white-space: nowrap; 
    user-select: none;
  }
  
  /* Sortable Headers */
  th.sortable {
    cursor: pointer;
    transition: background 0.1s;
  }
  th.sortable:hover {
    background-color: #f1f3f5;
    color: #007bff;
  }
  th.sortable::after {
    content: ' â†•';
    font-size: 10px;
    color: #ccc;
    margin-left: 4px;
  }
  th.sortable.asc::after { content: ' â†‘'; color: #007bff; }
  th.sortable.desc::after { content: ' â†“'; color: #007bff; }

  td { padding: 8px; border-bottom: 1px solid #f1f1f1; vertical-align: top; }
  
  /* Inputs in Table */
  input { padding: 8px; border: 1px solid #dfe3e8; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; transition: border 0.2s; }
  input:focus { border-color: #007bff; outline: none; background: #f9fbff; }
  
  .ticker-input { text-transform: uppercase; font-weight: bold; width: 70px; }
  .date-input { width: 130px; }
  .num-input { width: 90px; }
  .price-input { width: 100px; font-weight: 500; }
  
  /* Read-only Calculations */
  .calc-val { padding: 8px; font-size: 14px; font-weight: 500; min-width: 80px; display: block; }
  .gain-val { font-weight: 700; }

  /* Buttons */
  .btn { padding: 10px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
  .btn-sm { padding: 6px 10px; font-size: 12px; }
  .btn-primary { background: #007bff; color: white; }
  .btn-secondary { background: #6c757d; color: white; }
  .btn-magic { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .btn-csv { background: #28a745; color: white; }
  .btn-add { background: #e9ecef; color: #333; border: 1px solid #ced4da; }
  .btn-remove { background: transparent; color: #dc3545; border: 1px solid transparent; font-size: 18px; padding: 4px 8px; line-height: 1; }
  .btn:hover { opacity: 0.9; }
  .btn-remove:hover { background: #fee; border-color: #fcc; }

  /* Yahoo Link Button */
  .yahoo-link {
    display: flex; align-items: center; justify-content: center;
    background: #720e9e; color: white; text-decoration: none;
    font-size: 11px; font-weight: bold; width: 24px; height: 24px;
    border-radius: 4px; transition: background 0.2s;
  }
  .yahoo-link:hover { background: #500095; }

  /* Summary Section - Updated Grid */
  .summary-panel { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 15px; 
    margin-top: 20px; 
    padding-top: 20px; 
    border-top: 2px solid #eee; 
  }
  .summary-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
  .sum-label { font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px; }
  .sum-value { font-size: 24px; font-weight: 800; color: #333; }
  
  .positive { color: #28a745; }
  .negative { color: #dc3545; }

  /* Status Bar */
  #statusMsg { font-size: 13px; margin-left: auto; font-weight: 500; }
</style>
</head>
<body>

<h1>Portfolio Return Analyzer</h1>
<div class="subtitle">Multi-Stock Tracker â€¢ Historical Comparisons â€¢ No Key Required</div>

<div class="container">

  <!-- Global Settings -->
  <div class="global-controls">
    
    <!-- New: Global Start Date -->
    <div class="control-group">
      <label>Global Start Date</label>
      <div style="display:flex; gap:5px;">
        <input type="date" id="globalStartDate" class="date-input" style="width:140px;">
        <button class="btn btn-secondary btn-sm" onclick="applyGlobalStart()" title="Set this date for all stocks">Apply to All</button>
      </div>
    </div>

    <!-- Existing: Global End Date -->
    <div class="control-group">
      <label>Valuation Date (End Date)</label>
      <input type="date" id="globalEndDate" class="date-input" style="width:160px;">
    </div>
    
    <div class="control-group" style="flex:1;">
       <label>Actions</label>
       <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
         <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)">
         <button class="btn btn-csv" onclick="document.getElementById('csvInput').click()">ðŸ“‚ Import CSV</button>
         <button class="btn btn-magic" onclick="fetchAllYahoo()">âœ¨ Fetch Prices</button>
         <button class="btn btn-primary" onclick="calculateAll()">Recalculate</button>
         <div id="statusMsg"></div>
       </div>
    </div>
    
    <div style="font-size:12px;">
      <details>
        <summary style="cursor:pointer; color:#007bff;">API Settings</summary>
        <div style="position:absolute; background:white; padding:10px; border:1px solid #ccc; border-radius:4px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-top:5px; right: 40px; width:250px; z-index: 10;">
           <label>FMP Key (Optional)</label>
           <input type="text" id="apiKey" placeholder="Paste Key Here" style="margin-top:5px;">
           <button onclick="saveKey()" style="margin-top:5px; font-size:11px; padding:4px;">Save</button>
        </div>
      </details>
    </div>
  </div>

  <!-- Main Table -->
  <div class="table-wrapper">
    <table id="pfTable">
      <thead>
        <tr>
          <th class="sortable" onclick="sortPortfolio('ticker')">Ticker</th>
          <th width="80">Shares</th>
          <th width="140">Start Date</th>
          <th width="110">Start Price ($)</th>
          <th class="sortable" onclick="sortPortfolio('initial')">Initial Cost</th>
          <th width="110">End Price ($)</th>
          <th class="sortable" onclick="sortPortfolio('final')">Final Value</th>
          <th class="sortable" onclick="sortPortfolio('gain')">Gain/Loss ($)</th>
          <th class="sortable" onclick="sortPortfolio('return')">Return %</th>
          <th width="40"></th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Rows Generated Here -->
      </tbody>
    </table>
  </div>

  <button class="btn btn-add" onclick="addRow()">+ Add Stock</button>

  <!-- Summary Footer -->
  <div class="summary-panel">
    <div class="summary-card">
      <div class="sum-label">Total Invested (Start)</div>
      <div class="sum-value" id="sumInitial">$0.00</div>
    </div>
    <div class="summary-card">
      <div class="sum-label">Total Value (End)</div>
      <div class="sum-value" id="sumFinal">$0.00</div>
    </div>
    <div class="summary-card">
      <div class="sum-label">Total Gain / Loss</div>
      <div class="sum-value" id="sumGain">$0.00</div>
    </div>
    <div class="summary-card" style="background:#e3f2fd;">
      <div class="sum-label">Total Return %</div>
      <div class="sum-value" id="sumReturn" style="color:#007bff;">0.00%</div>
    </div>
    <div class="summary-card" style="background:#fff3cd;">
      <div class="sum-label">Annual Growth (CAGR)</div>
      <div class="sum-value" id="sumCAGR" style="color:#856404;">0.00%</div>
    </div>
  </div>

</div>

<script>
// --- STATE ---
let rowCount = 0;
let currentSort = { column: null, direction: 'asc' };
const defaultTickers = ['AAPL', 'MSFT', 'GOOGL'];

// --- INIT ---
document.getElementById('globalEndDate').value = dayjs().format("YYYY-MM-DD");
// Default start date (1 year ago)
document.getElementById('globalStartDate').value = dayjs().subtract(1, 'year').format("YYYY-MM-DD");

const savedKey = localStorage.getItem('fmp_key');
if(savedKey) document.getElementById('apiKey').value = savedKey;

// Add initial rows
defaultTickers.forEach(t => addRow(t));

// --- FUNCTIONS ---

function saveKey() {
    localStorage.setItem('fmp_key', document.getElementById('apiKey').value.trim());
    alert("Key Saved");
}

function updateYahooLink(id) {
    const row = document.getElementById(`row-${id}`);
    const ticker = row.querySelector('.ticker-input').value.toUpperCase();
    const link = row.querySelector('.yahoo-link');
    if(ticker) {
        link.href = `https://finance.yahoo.com/quote/${ticker}`;
        link.style.display = 'flex';
    } else {
        link.style.display = 'none';
    }
}

function applyGlobalStart() {
    const globalDate = document.getElementById('globalStartDate').value;
    if(!globalDate) return;
    
    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(tr => {
        tr.querySelector('.start-date').value = globalDate;
        // Visual feedback
        const dateInput = tr.querySelector('.start-date');
        dateInput.style.backgroundColor = "#e2e6ea";
        setTimeout(() => dateInput.style.backgroundColor = "", 500);
    });
}

function addRow(ticker = '', initialShares = 10) {
    rowCount++;
    const tbody = document.getElementById('tableBody');
    const tr = document.createElement('tr');
    tr.id = `row-${rowCount}`;
    
    // Default Start Date: Use global if set, otherwise 1 Year Ago
    let startDateVal = document.getElementById('globalStartDate').value;
    if(!startDateVal) startDateVal = dayjs().subtract(1, 'year').format("YYYY-MM-DD");

    tr.innerHTML = `
      <td>
        <div style="display:flex; align-items:center; gap:6px;">
          <input type="text" class="ticker-input" value="${ticker}" placeholder="SYM" 
                 oninput="this.value = this.value.toUpperCase(); updateYahooLink(${rowCount})">
          <a href="https://finance.yahoo.com/quote/${ticker}" target="_blank" class="yahoo-link" title="Open Yahoo Finance">Y!</a>
        </div>
      </td>
      <td><input type="number" class="num-input" value="${initialShares}" step="any" oninput="calcRow(${rowCount})"></td>
      <td><input type="date" class="date-input start-date" value="${startDateVal}" onchange="calcRow(${rowCount})"></td>
      <td><input type="number" class="price-input start-price" placeholder="0.00" step="0.01" oninput="calcRow(${rowCount})"></td>
      <td><span class="calc-val val-initial">$0.00</span></td>
      <td><input type="number" class="price-input end-price" placeholder="0.00" step="0.01" oninput="calcRow(${rowCount})"></td>
      <td><span class="calc-val val-final">$0.00</span></td>
      <td><span class="calc-val gain-val" style="color:#ccc;">$0.00</span></td>
      <td><span class="calc-val pct-val" style="color:#ccc;">0%</span></td>
      <td><button class="btn btn-remove" onclick="removeRow(${rowCount})">&times;</button></td>
    `;
    tbody.appendChild(tr);
    calcRow(rowCount); // Init zeros
}

function removeRow(id) {
    const row = document.getElementById(`row-${id}`);
    if(row) row.remove();
    calculateAll();
}

// --- SORTING LOGIC ---
function sortPortfolio(column) {
    const tbody = document.getElementById('tableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle direction
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        // Default sort direction: descending for numbers, ascending for text
        currentSort.direction = (column === 'ticker') ? 'asc' : 'desc';
    }

    // Sort Rows
    rows.sort((a, b) => {
        let valA, valB;

        if (column === 'ticker') {
            valA = a.querySelector('.ticker-input').value.toUpperCase();
            valB = b.querySelector('.ticker-input').value.toUpperCase();
            return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        } else {
            // Numeric Sorts
            if (column === 'initial') {
                valA = parseMoney(a.querySelector('.val-initial').textContent);
                valB = parseMoney(b.querySelector('.val-initial').textContent);
            } else if (column === 'final') {
                valA = parseMoney(a.querySelector('.val-final').textContent);
                valB = parseMoney(b.querySelector('.val-final').textContent);
            } else if (column === 'gain') {
                valA = parseMoney(a.querySelector('.gain-val').textContent);
                valB = parseMoney(b.querySelector('.gain-val').textContent);
            } else if (column === 'return') {
                valA = parseFloat(a.querySelector('.pct-val').textContent);
                valB = parseFloat(b.querySelector('.pct-val').textContent);
            }
            
            return currentSort.direction === 'asc' ? valA - valB : valB - valA;
        }
    });

    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));

    // Update Header Indicators
    document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
    });
    // Find the header matching the column and add class
    // Using mapping based on index or onclick content is tricky, let's look at onclick attr
    const targetTh = Array.from(document.querySelectorAll('th.sortable')).find(th => 
        th.getAttribute('onclick').includes(`'${column}'`)
    );
    if(targetTh) targetTh.classList.add(currentSort.direction);
}

function parseMoney(str) {
    return parseFloat(str.replace(/[^0-9.-]/g, '')) || 0;
}

// --- CSV IMPORT LOGIC ---

function handleFileSelect(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        processCSV(e.target.result);
        evt.target.value = '';
    };
    reader.readAsText(file);
}

function processCSV(text) {
    const lines = text.split(/\r\n|\n/);
    let addedCount = 0;

    lines.forEach(line => {
        if (!line.trim()) return;
        const parts = parseCSVLine(line);
        if(parts.length < 2) return;
        
        const ticker = parts[0].trim().replace(/^"|"$/g, '').toUpperCase();
        if(ticker.includes("TICKER")) return;
        
        let sharesStr = parts[1].trim().replace(/^"|"$/g, '').replace(/,/g, ''); 
        const shares = parseFloat(sharesStr);
        
        if (ticker && !isNaN(shares)) {
            addRow(ticker, shares);
            addedCount++;
        }
    });
    
    if(addedCount > 0) {
        document.getElementById('statusMsg').textContent = `Imported ${addedCount} stocks.`;
        document.getElementById('statusMsg').style.color = "green";
        calculateAll();
    } else {
        alert("No valid stock data found in CSV.");
    }
}

function parseCSVLine(text) {
    const result = [];
    let current = '';
    let inQuote = false;
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === '"') inQuote = !inQuote;
        else if (char === ',' && !inQuote) {
            result.push(current);
            current = '';
        } else current += char;
    }
    result.push(current);
    return result;
}


// --- CALCULATION LOGIC ---

function calcRow(id) {
    const row = document.getElementById(`row-${id}`);
    if(!row) return;

    const shares = parseFloat(row.querySelector('.num-input').value) || 0;
    const startPrice = parseFloat(row.querySelector('.start-price').value) || 0;
    const endPrice = parseFloat(row.querySelector('.end-price').value) || 0;

    const initialVal = shares * startPrice;
    const finalVal = shares * endPrice;
    const gain = finalVal - initialVal;
    const pct = initialVal > 0 ? (gain / initialVal) * 100 : 0;

    // Update Row UI
    row.querySelector('.val-initial').textContent = fmtMoney(initialVal);
    row.querySelector('.val-final').textContent = fmtMoney(finalVal);
    
    const gainEl = row.querySelector('.gain-val');
    gainEl.textContent = (gain >= 0 ? "+" : "") + fmtMoney(gain);
    gainEl.className = "calc-val gain-val " + (gain >= 0 ? "positive" : "negative");

    const pctEl = row.querySelector('.pct-val');
    pctEl.textContent = pct.toFixed(2) + "%";
    pctEl.className = "calc-val pct-val " + (gain >= 0 ? "positive" : "negative");

    // Trigger global calc
    updateSummary();
}

function calculateAll() {
    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(tr => {
        const id = tr.id.split('-')[1];
        calcRow(id);
    });
}

function updateSummary() {
    let totalInitial = 0;
    let totalFinal = 0;
    let weightedTimeAccumulator = 0; // Cost * Years
    
    const globalEndDateStr = document.getElementById('globalEndDate').value;
    const globalEndDate = dayjs(globalEndDateStr);

    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(tr => {
        const shares = parseFloat(tr.querySelector('.num-input').value) || 0;
        const sP = parseFloat(tr.querySelector('.start-price').value) || 0;
        const eP = parseFloat(tr.querySelector('.end-price').value) || 0;
        
        const initial = shares * sP;
        
        // Accumulate totals
        totalInitial += initial;
        totalFinal += (shares * eP);
        
        // Calculate Weighted Time for CAGR
        // Get this row's start date
        const rowStartDateVal = tr.querySelector('.start-date').value;
        if(rowStartDateVal && globalEndDateStr && initial > 0) {
            const sDate = dayjs(rowStartDateVal);
            const diffDays = globalEndDate.diff(sDate, 'day');
            const years = diffDays / 365.25;
            weightedTimeAccumulator += (initial * years);
        }
    });

    const totalGain = totalFinal - totalInitial;
    const totalReturn = totalInitial > 0 ? (totalGain / totalInitial) * 100 : 0;
    
    // Calculate Weighted Average Years
    const avgYears = totalInitial > 0 ? weightedTimeAccumulator / totalInitial : 0;
    
    // Calculate Portfolio CAGR
    // Formula: (Final / Initial)^(1/years) - 1
    let cagr = 0;
    if(totalInitial > 0 && totalFinal > 0 && avgYears > 0.01) {
        cagr = (Math.pow((totalFinal / totalInitial), (1 / avgYears)) - 1) * 100;
    } else if (totalInitial > 0 && totalFinal > 0 && avgYears <= 0.01) {
        // Fallback for very short periods to avoid infinity
        // Or simply show simple return if time < 4 days
        cagr = totalReturn; 
    }

    // Display Updates
    document.getElementById('sumInitial').textContent = fmtMoney(totalInitial);
    document.getElementById('sumFinal').textContent = fmtMoney(totalFinal);
    
    const gainEl = document.getElementById('sumGain');
    gainEl.textContent = (totalGain >= 0 ? "+" : "") + fmtMoney(totalGain);
    gainEl.className = "sum-value " + (totalGain >= 0 ? "positive" : "negative");

    const retEl = document.getElementById('sumReturn');
    retEl.textContent = totalReturn.toFixed(2) + "%";
    retEl.className = "sum-value " + (totalReturn >= 0 ? "positive" : "negative");
    
    const cagrEl = document.getElementById('sumCAGR');
    cagrEl.textContent = cagr.toFixed(2) + "%";
    // Color code CAGR nicely
    cagrEl.className = "sum-value " + (cagr >= 0 ? "positive" : "negative");
}

function fmtMoney(n) {
    return "$" + n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// --- FETCH LOGIC (YAHOO PROXY - BATCH) ---

async function fetchAllYahoo() {
    const rows = document.querySelectorAll('#tableBody tr');
    const endDate = document.getElementById('globalEndDate').value;
    const status = document.getElementById('statusMsg');

    if(!endDate) { alert("Please select a Valuation Date (End Date)"); return; }

    status.textContent = "Fetching...";
    status.style.color = "blue";

    // Process Sequentially to avoid overwhelming proxy
    for (const tr of rows) {
        const ticker = tr.querySelector('.ticker-input').value.toUpperCase();
        if(!ticker) continue;
        
        const startDate = tr.querySelector('.start-date').value;
        const id = tr.id.split('-')[1];

        // Highlight Row
        tr.style.backgroundColor = "#f0f8ff";

        try {
            await fetchRowYahoo(tr, ticker, startDate, endDate);
        } catch(err) {
            console.error(`Failed ${ticker}:`, err);
        }

        // Unhighlight
        tr.style.backgroundColor = "";
        calcRow(id);
        
        // Small delay
        await new Promise(r => setTimeout(r, 200)); 
    }
    
    status.textContent = "Done!";
    status.style.color = "green";
    setTimeout(() => status.textContent = "", 3000);
}

async function fetchRowYahoo(tr, ticker, d1, d2) {
    // UPDATED: Using range=max to ensure we can get prices further back than 10 years
    const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=max`;
    const proxyUrl = `https://corsproxy.io/?` + encodeURIComponent(targetUrl);
    
    const res = await fetch(proxyUrl);
    if(!res.ok) return; // Skip silently on fail
    
    const json = await res.json();
    const result = json.chart.result?.[0];
    if(!result) return;

    const timestamps = result.timestamp;
    const quotes = result.indicators.quote[0].close;

    const findPrice = (dateStr) => {
        const targetTime = dayjs(dateStr).unix();
        let closestPrice = null;
        let minDiff = Infinity;
        
        // Loop backwards
        for(let i = timestamps.length - 1; i >= 0; i--) {
            const diff = Math.abs(timestamps[i] - targetTime);
            // Within 4 days
            if(diff < 345600) { 
                if(diff < minDiff) {
                    minDiff = diff;
                    closestPrice = quotes[i];
                }
            }
            // Optimization: if we are more than 5 days past target time, we can stop searching backwards
            if(timestamps[i] < targetTime - 432000) break;
        }
        return closestPrice;
    };

    // 1. Start Price
    if(d1) {
        const p1 = findPrice(d1);
        if(p1) {
            tr.querySelector('.start-price').value = p1.toFixed(2);
            flash(tr.querySelector('.start-price'));
        }
    }

    // 2. End Price
    if(d2) {
        const p2 = findPrice(d2);
        if(p2) {
            tr.querySelector('.end-price').value = p2.toFixed(2);
            flash(tr.querySelector('.end-price'));
        }
    }
}

function flash(el) {
    el.style.backgroundColor = "#d4edda";
    setTimeout(() => el.style.backgroundColor = "", 1000);
}

</script>
</body>
</html>
