<script>
  const tbody = document.querySelector("#portfolioTable tbody");
  const addBtn = document.getElementById("addStock");
  const evalDateInput = document.getElementById("evalDate");
  let stockRows = [];
  let totalCost = 0;

  // FIXED: Use AllOrigins proxy for CORS bypass
  const API_PROXY = "https://api.allorigins.win/raw?url=";

  evalDateInput.value = dayjs().format("YYYY-MM-DD");

  function createRow() {
    if (stockRows.length >= 10) { alert("Max 10 stocks"); return; }
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${stockRows.length + 1}</td>
      <td><input class="ticker" placeholder="AAPL" style="width:90px"></td>
      <td><input type="number" class="shares" min="0" step="0.001" style="width:90px"></td>
      <td><input type="number" class="price" step="0.01" placeholder="or date →"></td>
      <td><input type="date" class="purchaseDate"></td>
      <td class="cost">-</td>
      <td class="currentPrice loading">Loading…</td>
      <td class="marketValue">-</td>
      <td class="gainDollar">-</td>
      <td class="gainPct">-</td>
      <td><button class="remove-btn">X</button></td>
    `;
    tr.querySelector(".remove-btn").onclick = () => {
      tr.remove();
      stockRows = stockRows.filter(r => r !== tr);
      stockRows.forEach((r,i) => r.querySelector("td:first-child").textContent = i+1);
      calculateAll();
    };
    ["ticker","shares","price","purchaseDate"].forEach(c => 
      tr.querySelector(`.${c}`).addEventListener("input", calculateAll)
    );
    tbody.appendChild(tr);
    stockRows.push(tr);
  }

  addBtn.onclick = createRow;
  evalDateInput.onchange = calculateAll;

  async function calculateAll() {
    const evalDate = evalDateInput.value;
    totalCost = 0;
    let totalValue = 0;

    stockRows.forEach(row => {
      row.querySelector(".currentPrice").textContent = "Loading…";
      row.querySelector(".currentPrice").className = "currentPrice loading";
      row.querySelector(".cost").textContent = "-";
      row.querySelector(".marketValue").textContent = "-";
      row.querySelector(".gainDollar").textContent = "-";
      row.querySelector(".gainPct").textContent = "-";
    });

    const tickers = stockRows
      .map(r => r.querySelector(".ticker").value.trim().toUpperCase())
      .filter(Boolean);

    if (!tickers.length) return updateSummary(0,0);

    try {
      // FIXED: Proxy + encodeURIComponent for quotes
      const quoteUrl = API_PROXY + encodeURIComponent("https://query1.finance.yahoo.com/v7/finance/quote?symbols=" + tickers.join(","));
      const quoteResp = await axios.get(quoteUrl);
      const quotes = quoteResp.data.quoteResponse.result;

      for (let row of stockRows) {
        const ticker = row.querySelector(".ticker").value.trim().toUpperCase();
        const shares = parseFloat(row.querySelector(".shares").value) || 0;
        if (!ticker || shares <= 0) continue;

        const q = quotes.find(x => x.symbol === ticker);
        if (!q) { row.querySelector(".currentPrice").textContent = "Invalid"; continue; }

        const priceNow = q.regularMarketPrice || q.postMarketPrice || q.preMarketPrice;
        row.querySelector(".currentPrice").textContent = priceNow.toFixed(2);
        row.querySelector(".currentPrice").classList.remove("loading");

        // Cost basis
        let cost = 0;
        const manualPrice = parseFloat(row.querySelector(".price").value);
        if (manualPrice > 0) {
          cost = manualPrice * shares;
        } else {
          const purchaseDate = row.querySelector(".purchaseDate").value;
          if (purchaseDate) {
            try {
              // FIXED: Proxy + encodeURIComponent for historical
              const histUrl = API_PROXY + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=5y&interval=1d`);
              const histRes = await axios.get(histUrl);
              const ts = histRes.data.chart.result[0].timestamp;
              const close = histRes.data.chart.result[0].indicators.quote[0].close;
              const target = new Date(purchaseDate).getTime() / 1000;
              let bestIdx = ts.findIndex(t => t >= target);
              let best = (bestIdx !== -1 ? close[bestIdx] : close[close.length - 1]) || priceNow;
              cost = best * shares;
              row.querySelector(".price").value = best.toFixed(2);
            } catch(e) { 
              console.error("Historical fetch failed:", e);
              row.querySelector(".purchaseDate").style.borderColor = "red";
            }
          }
        }

        const value = priceNow * shares;
        const gain$ = value - cost;
        const gainPct = cost > 0 ? (gain$ / cost) * 100 : 0;

        row.querySelector(".cost").textContent = cost.toFixed(2);
        row.querySelector(".marketValue").textContent = value.toFixed(2);
        row.querySelector(".gainDollar").textContent = gain$.toFixed(2);
        row.querySelector(".gainDollar").style.color = gain$ >= 0 ? "green" : "red";
        row.querySelector(".gainPct").textContent = gainPct.toFixed(1) + "%";
        row.querySelector(".gainPct").style.color = gain$ >= 0 ? "green" : "red";

        totalCost += cost;
        totalValue += value;
      }

      updateSummary(totalValue, totalValue - totalCost);
    } catch (e) {
      console.error("Fetch error:", e);
      alert("Fetch failed (CORS or network issue). Try a different browser or check console for details.");
    }
  }

  function updateSummary(val, gain) {
    document.getElementById("totalValue").textContent = "$" + val.toFixed(2);
    const gainStr = (gain >= 0 ? "+" : "") + "$" + gain.toFixed(2);
    const gainPctStr = totalCost > 0 ? (gain / totalCost * 100).toFixed(1) + "%" : "–%";
    document.getElementById("totalGain").innerHTML = gainStr;
    document.getElementById("totalGain").style.color = gain >= 0 ? "green" : "red";
    document.getElementById("totalGainPct").textContent = gainPctStr;
    document.getElementById("totalGainPct").style.color = gain >= 0 ? "green" : "red";
  }

  // Start with one empty row
  createRow();
</script>
