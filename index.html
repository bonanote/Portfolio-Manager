<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Stock Return Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background: #f0f4f8; color: #333; }
  h1 { text-align: center; color: #1a1a1a; margin-bottom: 10px; }
  .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 0.9em; }

  /* Layout */
  .container { max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
  @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }

  /* Cards */
  .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
  
  /* Inputs */
  .input-group { margin-bottom: 15px; }
  label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
  input[type="text"], input[type="number"], input[type="date"] {
    width: 100%; padding: 10px; border: 1px solid #dfe3e8; border-radius: 6px; font-size: 16px; box-sizing: border-box; transition: all 0.2s;
  }
  input:focus { border-color: #007bff; outline: none; background: #f9fbff; }
  
  /* Special Inputs */
  .ticker-input { text-transform: uppercase; letter-spacing: 1px; font-weight: bold; font-size: 18px !important; }
  .price-row { display: flex; gap: 10px; align-items: flex-end; }
  .price-input-wrapper { flex: 1; position: relative; }
  .price-input-wrapper span { position: absolute; left: 10px; top: 10px; color: #666; }
  .price-input-wrapper input { padding-left: 20px; font-weight: bold; color: #333; }
  
  /* Buttons */
  .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
  .btn-primary { background: #007bff; color: white; }
  .btn-outline { background: transparent; border: 1px solid #ccc; color: #666; margin-top: 10px; }
  .btn-magic { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .btn:hover { opacity: 0.9; transform: translateY(-1px); }

  /* Results Panel */
  .results-header { font-size: 18px; font-weight: bold; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
  .result-item { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 15px; }
  .big-metric { text-align: center; margin: 25px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
  .metric-label { font-size: 13px; color: #666; text-transform: uppercase; }
  .metric-value { font-size: 32px; font-weight: 800; color: #333; }
  
  .positive { color: #28a745; }
  .negative { color: #dc3545; }

  /* Status Bar */
  #apiStatus { font-size: 13px; text-align: center; margin-top: 10px; min-height: 20px; }

  /* Yahoo Link */
  .yahoo-btn {
      display: inline-block; text-decoration: none; background: #720e9e; color: white; 
      padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px;
  }
</style>
</head>
<body>

<h1>Stock Return Analyzer</h1>
<div class="subtitle">Compare Start vs. End Dates • Calculate Returns</div>

<div class="container">
  
  <!-- LEFT COLUMN: INPUTS -->
  <div class="card">
    
    <div class="input-group">
      <label>Stock Ticker</label>
      <div style="display:flex; align-items:center;">
        <input type="text" id="ticker" class="ticker-input" placeholder="AAPL" value="AAPL">
        <a id="yahooLink" href="https://finance.yahoo.com/quote/AAPL" target="_blank" class="yahoo-btn">View on Yahoo</a>
      </div>
    </div>

    <div class="input-group">
      <label>Shares Owned</label>
      <input type="number" id="shares" value="100">
    </div>

    <hr style="border:0; border-top:1px solid #eee; margin:25px 0;">

    <!-- DATE 1 (START) -->
    <div class="input-group">
      <label>Start Date (Purchase)</label>
      <div class="price-row">
        <input type="date" id="date1">
        <div class="price-input-wrapper">
          <span>$</span>
          <input type="number" id="price1" placeholder="Start Price" step="0.01">
        </div>
      </div>
    </div>

    <!-- DATE 2 (END) -->
    <div class="input-group">
      <label>End Date (Sale/Current)</label>
      <div class="price-row">
        <input type="date" id="date2">
        <div class="price-input-wrapper">
          <span>$</span>
          <input type="number" id="price2" placeholder="End Price" step="0.01">
        </div>
      </div>
    </div>

    <div id="apiStatus"></div>

    <button class="btn btn-magic" onclick="fetchYahooNoKey()">✨ Magic No-Key Fetch (Yahoo)</button>
    
    <!-- Collapsible Advanced API Option -->
    <details style="margin-top:20px; font-size:12px; color:#666;">
        <summary style="cursor:pointer; padding:5px;">Advanced: Use FMP API Key (Faster)</summary>
        <div style="background:#fff3cd; padding:10px; border-radius:6px; margin-top:10px; border:1px solid #ffeeba;">
            <input type="text" id="apiKey" placeholder="Paste FMP Key Here" style="font-size:13px; padding:6px; width:100%; box-sizing:border-box;">
            <button onclick="saveKey()" style="margin-top:5px; padding:5px 10px; cursor:pointer;">Save Key</button>
            <button onclick="fetchData()" style="margin-top:5px; padding:5px 10px; cursor:pointer;">Fetch with Key</button>
        </div>
    </details>

    <button class="btn btn-primary" style="margin-top:15px;" id="calcBtn" onclick="calculate()">Recalculate Results</button>
  </div>

  <!-- RIGHT COLUMN: RESULTS -->
  <div class="card">
    <div class="results-header">Performance Analysis</div>
    
    <div class="result-item">
      <span>Initial Investment:</span>
      <span id="resInitial" style="font-weight:bold;">$0.00</span>
    </div>
    <div class="result-item">
      <span>Final Value:</span>
      <span id="resFinal" style="font-weight:bold;">$0.00</span>
    </div>
    <div class="result-item">
      <span>Time Period:</span>
      <span id="resYears">0.0 Years</span>
    </div>

    <div class="big-metric">
      <div class="metric-label">Total Gain / Loss</div>
      <div class="metric-value" id="resGain">$0.00</div>
    </div>

    <div class="big-metric">
      <div class="metric-label">Total Return %</div>
      <div class="metric-value" id="resReturn">0.00%</div>
    </div>

    <div class="big-metric" style="background:#e3f2fd;">
      <div class="metric-label">Annualized Return (CAGR)</div>
      <div class="metric-value" id="resCAGR" style="color:#007bff;">0.00%</div>
    </div>
  </div>

</div>

<script>
// Elements
const els = {
  key: document.getElementById('apiKey'),
  ticker: document.getElementById('ticker'),
  shares: document.getElementById('shares'),
  d1: document.getElementById('date1'),
  p1: document.getElementById('price1'),
  d2: document.getElementById('date2'),
  p2: document.getElementById('price2'),
  status: document.getElementById('apiStatus'),
  yahoo: document.getElementById('yahooLink')
};

// Init
const savedKey = localStorage.getItem('fmp_key');
if(savedKey) els.key.value = savedKey;

// Defaults: Start = 1 year ago, End = Today
els.d2.value = dayjs().format("YYYY-MM-DD");
els.d1.value = dayjs().subtract(1, 'year').format("YYYY-MM-DD");

// Events
els.ticker.addEventListener('input', () => {
    els.yahoo.href = `https://finance.yahoo.com/quote/${els.ticker.value}`;
    calculate();
});
['shares','p1','p2'].forEach(id => document.getElementById(id).addEventListener('input', calculate));

function saveKey() {
    localStorage.setItem('fmp_key', els.key.value.trim());
    alert("Key Saved");
}

function updateStatus(msg, color) {
    els.status.innerHTML = `<span style="color:${color}">${msg}</span>`;
}

// --- YAHOO NO-KEY FETCH (VIA PROXY) ---
async function fetchYahooNoKey() {
    const ticker = els.ticker.value.toUpperCase();
    if(!ticker) { alert("Please enter a ticker"); return; }
    
    updateStatus("Contacting Yahoo Finance via Proxy...", "blue");
    
    try {
        // We request 10 years of data to ensure we cover the start date
        // URL is passed to corsproxy.io to bypass browser security
        const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=20y`;
        const proxyUrl = `https://corsproxy.io/?` + encodeURIComponent(targetUrl);
        
        const res = await fetch(proxyUrl);
        if(!res.ok) throw new Error("Yahoo/Proxy Connection Failed");
        
        const json = await res.json();
        const result = json.chart.result?.[0];
        
        if(!result) throw new Error("No data found for this ticker");
        
        const timestamps = result.timestamp; // Unix seconds
        const quotes = result.indicators.quote[0].close;
        
        // Helper to find price
        const findPrice = (dateStr) => {
            const targetTime = dayjs(dateStr).unix();
            let closestPrice = null;
            let minDiff = Infinity;
            
            // Loop backwards (more efficient for recent dates)
            for(let i = timestamps.length - 1; i >= 0; i--) {
                const diff = Math.abs(timestamps[i] - targetTime);
                
                // If we are within 4 days (covers weekends/holidays)
                if(diff < 345600) { 
                    if(diff < minDiff) {
                        minDiff = diff;
                        closestPrice = quotes[i];
                    }
                }
                // Optimization: if we went too far back past target, stop
                if(timestamps[i] < targetTime - 400000) break;
            }
            return closestPrice;
        };

        // 1. Get Start Price
        if(els.d1.value) {
            const p1 = findPrice(els.d1.value);
            if(p1) {
                els.p1.value = p1.toFixed(2);
                highlight(els.p1);
            }
        }

        // 2. Get End Price
        if(els.d2.value) {
            const p2 = findPrice(els.d2.value);
            if(p2) {
                els.p2.value = p2.toFixed(2);
                highlight(els.p2);
            }
        }
        
        updateStatus("Success! Prices updated from Yahoo.", "green");
        calculate();

    } catch(err) {
        console.error(err);
        updateStatus("Fetch failed. Try manual entry or check network.", "red");
        alert("Could not fetch from Yahoo.\n\nNote: Public proxies sometimes get overloaded. If this persists, please use the manual entry boxes.");
    }
}

// --- FMP API FETCH (OPTIONAL) ---
async function fetchData() {
    const key = els.key.value.trim();
    const ticker = els.ticker.value.toUpperCase();
    if(!key) { alert("API Key required for this method."); return; }

    updateStatus("Fetching from FMP API...", "blue");

    try {
        if(els.d1.value) {
            const p1 = await getFMPPrice(ticker, els.d1.value, key);
            if(p1) { els.p1.value = p1; highlight(els.p1); }
        }
        if(els.d2.value) {
            const p2 = await getFMPPrice(ticker, els.d2.value, key);
            if(p2) { els.p2.value = p2; highlight(els.p2); }
        }
        updateStatus("FMP Fetch Complete.", "green");
        calculate();
    } catch(e) {
        console.error(e);
        updateStatus("FMP Error: " + e.message, "red");
    }
}

async function getFMPPrice(ticker, dateStr, key) {
    const from = dayjs(dateStr).subtract(4, 'day').format("YYYY-MM-DD");
    const to = dayjs(dateStr).add(4, 'day').format("YYYY-MM-DD");
    const url = `https://financialmodelingprep.com/api/v3/historical-price-full/${ticker}?from=${from}&to=${to}&apikey=${key}`;
    const res = await fetch(url);
    const data = await res.json();
    if(data["Error Message"]) throw new Error(data["Error Message"]);
    const hist = data.historical || [];
    if(hist.length === 0) return null;
    
    // Find closest
    const target = dayjs(dateStr);
    let closest = null;
    let minDiff = Infinity;
    hist.forEach(day => {
        const diff = Math.abs(dayjs(day.date).diff(target, 'day'));
        if(diff < minDiff) { minDiff = diff; closest = day.close; }
    });
    return closest;
}

function highlight(el) {
    el.style.backgroundColor = "#d4edda";
    setTimeout(() => el.style.backgroundColor = "", 1000);
}

// --- CALCULATION LOGIC ---
function calculate() {
    const shares = parseFloat(els.shares.value) || 0;
    const p1 = parseFloat(els.p1.value) || 0;
    const p2 = parseFloat(els.p2.value) || 0;
    const d1 = dayjs(els.d1.value);
    const d2 = dayjs(els.d2.value);

    const initialVal = shares * p1;
    const finalVal = shares * p2;
    const gain = finalVal - initialVal;
    
    const diffDays = d2.diff(d1, 'day');
    const years = diffDays / 365.25;
    const totalReturnPct = initialVal > 0 ? (gain / initialVal) : 0;
    
    let cagr = 0;
    if(initialVal > 0 && finalVal > 0 && years > 0.1) {
        cagr = Math.pow((finalVal / initialVal), (1 / years)) - 1;
    }

    document.getElementById('resInitial').textContent = fmtMoney(initialVal);
    document.getElementById('resFinal').textContent = fmtMoney(finalVal);
    document.getElementById('resYears').textContent = `${years.toFixed(2)} Years`;
    
    const gainEl = document.getElementById('resGain');
    gainEl.textContent = (gain >= 0 ? "+" : "") + fmtMoney(gain);
    gainEl.className = "metric-value " + (gain >= 0 ? "positive" : "negative");

    const retEl = document.getElementById('resReturn');
    retEl.textContent = (totalReturnPct * 100).toFixed(2) + "%";
    retEl.className = "metric-value " + (totalReturnPct >= 0 ? "positive" : "negative");

    document.getElementById('resCAGR').textContent = (cagr * 100).toFixed(2) + "%";
}

function fmtMoney(num) {
    return "$" + num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

calculate();
</script>
</body>
</html>
