<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stock Portfolio Tracker – Works 100% (Nov 2025)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
<style>
  body { font-family: system-ui, -apple-system, Arial; margin:20px; background:#f9f9f9; }
  h1 { text-align:center; color:#111; }
  button { padding:12px 24px; font-size:18px; background:#0066ff; color:white; border:none; border-radius:8px; cursor:pointer; }
  table { width:100%; border-collapse:collapse; margin-top:20px; background:white; border-radius:12px; overflow:hidden; box-shadow:0 6px 25px rgba(0,0,0,0.1); }
  th { background:#0066ff; color:white; padding:15px; }
  td { padding:12px; border-bottom:1px solid #eee; }
  input { padding:10px; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; font-size:16px; }
  .remove-btn { background:#e74c3c; color:white; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  #summary { margin-top:30px; padding:25px; background:#e8f5e8; border-radius:12px; text-align:center; font-size:1.5em; font-weight:bold; }
</style>
</head>
<body>

<h1>My Stock Portfolio Tracker (10 stocks max)</h1>

<div style="text-align:center; margin:30px 0;">
  <button id="addStock">+ Add Stock</button>
  <span style="margin-left:40px; font-size:18px;">
    Evaluation date: <input type="date" id="evalDate">
  </span>
</div>

<table id="portfolioTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Ticker</th>
      <th>Shares</th>
      <th>Purchase Price $</th>
      <th>OR Purchase Date</th>
      <th>Cost Basis</th>
      <th>Current Price</th>
      <th>Value Now</th>
      <th>Gain $</th>
      <th>Gain %</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="summary">
  Total value: <span id="totalValue">$0.00</span><br>
  Gain/Loss: <span id="totalGain">$0.00</span> (<span id="totalGainPct">0%</span>)
</div>

<script>
// BEST PROXY RIGHT NOW (Nov 2025) – allorigins returns raw response
const PROXY = "https://api.allorigins.win/raw?url=";

const tbody = document.querySelector("#portfolioTable tbody");
const addBtn = document.getElementById("addStock");
const evalDateInput = document.getElementById("evalDate");
let rows = [];
let totalCostGlobal = 0;

evalDateInput.value = dayjs().format("YYYY-MM-DD");

function addRow() {
  if (rows.length >= 10) { alert("Max 10 stocks"); return; }
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="num">${rows.length + 1}</td>
    <td><input class="ticker" placeholder="AAPL"></td>
    <td><input type="number" class="shares" min="0" step="0.001" placeholder="100"></td>
    <td><input type="number" class="price" step="0.01" placeholder="or use date →"></td>
    <td><input type="date" class="purchaseDate"></td>
    <td class="cost">-</td>
    <td class="currentPrice">–</td>
    <td class="value">-</td>
    <td class="gainDollar">-</td>
    <td class="gainPercent">-</td>
    <td><button class="remove-btn">X</button></td>
  `;

  tr.querySelector(".remove-btn").onclick = () => {
    tr.remove();
    rows = rows.filter(r => r !== tr);
    rows.forEach((r,i) => r.querySelector(".num").textContent = i+1);
    refresh();
  };

  ["ticker","shares","price","purchaseDate"].forEach(c =>
    tr.querySelector(`.${c}`).addEventListener("input", refresh)
  );

  tbody.appendChild(tr);
  rows.push(tr);
}

addBtn.onclick = addRow;

async function refresh() {
  totalCostGlobal = 0;
  let totalValue = 0;

  // reset rows
  rows.forEach(r => {
    r.querySelector(".currentPrice").textContent = "Loading…";
    ["cost","value","gainDollar","gainPercent"].forEach(c => r.querySelector("." + c).textContent = "-");
  });

  const tickers = rows.map(r => r.querySelector(".ticker").value.trim().toUpperCase()).filter(Boolean);
  if (tickers.length === 0) return updateSummary(0, 0);

  try {
    // Current prices
    const quoteUrl = PROXY + encodeURIComponent("https://query1.finance.yahoo.com/v7/finance/quote?symbols=" + tickers.join(","));
    const resp = await axios.get(quoteUrl);
    const data = resp.data;

    // Safety: sometimes Yahoo returns {quoteResponse:{result:[],error:...}}
    if (!data.quoteResponse || !data.quoteResponse.result) {
      throw new Error("No result from Yahoo");
    }
    const quotes = data.quoteResponse.result;

    for (const row of rows) {
      const ticker = row.querySelector(".ticker").value.trim().toUpperCase();
      const shares = parseFloat(row.querySelector(".shares").value) || 0;
      if (!ticker || shares <= 0) continue;

      const q = quotes.find(x => x.symbol === ticker);
      if (!q) {
        row.querySelector(".currentPrice").textContent = "Not found";
        continue;
      }

      const priceNow = q.regularMarketPrice ?? q.postMarketPrice ?? q.preMarketPrice ?? 0;
      row.querySelector(".currentPrice").textContent = priceNow.toFixed(2);

      // Cost basis
      let costBasis = 0;
      const manualPrice = parseFloat(row.querySelector(".price").value);
      if (manualPrice > 0) {
        costBasis = manualPrice * shares;
      } else if (row.querySelector(".purchaseDate").value) {
        const date = row.querySelector(".purchaseDate").value;
        try {
          const chartUrl = PROXY + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=5y&interval=1d`);
          const chartResp = await axios.get(chartUrl);
          const ts = chartResp.data.chart.result[0].timestamp;
          const close = chartResp.data.chart.result[0].indicators.quote[0].close;
          const target = new Date(date).getTime() / 1000;

          let priceAtDate = close[close.length-1];
          for (let i = 0; i < ts.length; i++) {
            if (ts[i] >= target) { priceAtDate = close[i]; break; }
          }
          if (priceAtDate) {
            costBasis = priceAtDate * shares;
            row.querySelector(".price").value = priceAtDate.toFixed(2);
          }
        } catch (e) { /* silently fail, just leave cost 0 */ }
      }

      const marketValue = priceNow * shares;
      const gain = marketValue - costBasis;
      const gainPct = costBasis > 0 ? gain / costBasis * 100 : 0;

      row.querySelector(".cost").textContent = costBasis.toFixed(2);
      row.querySelector(".value").textContent = marketValue.toFixed(2);
      row.querySelector(".gainDollar").textContent = gain.toFixed(2);
      row.querySelector(".gainDollar").style.color = gain >= 0 ? "green" : "red";
      row.querySelector(".gainPercent").textContent = gainPct.toFixed(1) + "%";
      row.querySelector(".gainPercent").style.color = gain >= 0 ? "green" : "red";

      totalCostGlobal += costBasis;
      totalValue += marketValue;
    }

    updateSummary(totalValue, totalValue - totalCostGlobal);

  } catch (err) {
    console.error("Fetch failed:", err);
    alert("Yahoo Finance temporarily blocked the request. Wait 30–60 seconds and try again, or try fewer stocks at once.");
  }
}

function updateSummary(value, gain) {
  document.getElementById("totalValue").textContent = "$" + value.toFixed(2);
  const gainStr = (gain >= 0 ? "+" : "") + "$" + gain.toFixed(2);
  document.getElementById("totalGain").textContent = gainStr;
  document.getElementById("totalGain").style.color = gain >= 0 ? "green" : "red";
  const pct = totalCostGlobal > 0 ? (gain / totalCostGlobal * 100).toFixed(1) + "%" : "0%";
  document.getElementById("totalGainPct").textContent = pct;
  document.getElementById("totalGainPct").style.color = gain >= 0 ? "green" : "red";
}

// Start
addRow();
</script>
</body>
</html>
