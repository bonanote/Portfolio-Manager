<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stock Portfolio Tracker – Works Everywhere</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
<style>
  body { font-family: -apple-system, Arial, sans-serif; margin:20px; background:#f5f7fa; line-height:1.5; }
  h1 { text-align:center; color:#1a1a1a; }
  button { padding:12px 20px; font-size:18px; background:#0066ff; color:white; border:none; border-radius:8px; cursor:pointer; }
  table { width:100%; border-collapse:collapse; margin-top:20px; background:white; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
  th { background:#0066ff; color:white; padding:14px; text-align:left; }
  td { padding:10px; border-bottom:1px solid #eee; }
  input { padding:10px; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; font-size:16px; }
  .remove-btn { background:#ff4444; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
  #summary { margin-top:30px; padding:20px; background:#e3f2fd; border-radius:12px; text-align:center; font-size:1.4em; }
  .loading { color:#ff9800; font-style:italic; }
  .error { color:#f44336; }
</style>
</head>
<body>

<h1>My Stock Portfolio Tracker (up to 10 stocks)</h1>

<div style="text-align:center; margin:20px;">
  <button id="addStock">+ Add Stock</button>
  <span style="margin-left:30px; font-size:18px;">
    Evaluation date: <input type="date" id="evalDate">
  </span>
</div>

<table id="portfolioTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Ticker</th>
      <th>Shares</th>
      <th>Purchase $<br><small>(or leave blank)</th>
      <th>Purchase Date</th>
      <th>Cost Basis</th>
      <th>Price Now</th>
      <th>Value</th>
      <th>Gain $</th>
      <th>Gain %</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="summary">
  Total value: <span id="totalValue">$0.00</span><br>
  Total gain/loss: <span id="totalGain">$0.00</span> (<span id="totalGainPct">0%</span>)
</div>

<script>
// ──────────────────────────────────────────────────────────────
//  THIS PROXY IS CURRENTLY THE MOST RELIABLE IN 2025 FOR YAHOO
// ──────────────────────────────────────────────────────────────
const PROXY = "https://corsproxy.io/?";

const tbody = document.querySelector("#portfolioTable tbody");
const addBtn = document.getElementById("addStock");
const evalDateInput = document.getElementById("evalDate");
let rows = [];

evalDateInput.value = dayjs().format("YYYY-MM-DD");

function addRow() {
  if (rows.length >= 10) { alert("Maximum 10 stocks"); return; }
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${rows.length + 1}</td>
    <td><input class="ticker" placeholder="AAPL"></td>
    <td><input type="number" class="shares" min="0" step="0.001" placeholder="100"></td>
    <td><input type="number" class="price" step="0.01" placeholder="or use date →"></td>
    <td><input type="date" class="purchaseDate"></td>
    <td class="cost">-</td>
    <td class="currentPrice loading">Loading…</td>
    <td class="value">-</td>
    <td class="gain$">-</td>
    <td class="gainPct">-</td>
    <td><button class="remove-btn">X</button></td>
  `;

  tr.querySelector(".remove-btn").onclick = () => {
    tr.remove();
    rows = rows.filter(r => r !== tr);
    rows.forEach((r,i) => r.querySelector("td:first-child").textContent = i+1);
    refresh();
  };

  ["ticker","shares","price","purchaseDate"].forEach(cls =>
    tr.querySelector(`.${cls}`).addEventListener("input", refresh)
  );

  tbody.appendChild(tr);
  rows.push(tr);
}

addBtn.onclick = addRow;
evalDateInput.onchange = refresh;

async function refresh() {
  let totalCost = 0;
  let totalValue = 0;

  // reset loading states
  rows.forEach(r => {
    r.querySelector(".currentPrice").textContent = "Loading…";
    r.querySelector(".currentPrice").className = "currentPrice loading";
    r.querySelector(".cost").textContent = "-";
    r.querySelector(".value").textContent = "-";
    r.querySelector(".gain$").textContent = "-";
    r.querySelector(".gainPct").textContent = "-";
  });

  const tickers = rows.map(r => r.querySelector(".ticker").value.trim().toUpperCase()).filter(Boolean);
  if (tickers.length === 0) return updateSummary(0,0);

  try {
    // 1. Get current prices
    const quoteUrl = PROXY + encodeURIComponent(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${tickers.join(",")}`);
    const { data } = await axios.get(quoteUrl);
    const quotes = data.quoteResponse.result;

    for (const row of rows) {
      const ticker = row.querySelector(".ticker").value.trim().toUpperCase();
      const shares = parseFloat(row.querySelector(".shares").value) || 0;
      if (!ticker || shares <= 0) continue;

      const quote = quotes.find(q => q.symbol === ticker);
      if (!quote) {
        row.querySelector(".currentPrice").textContent = "Invalid";
        row.querySelector(".currentPrice").className = "currentPrice error";
        continue;
      }

      const priceNow = quote.regularMarketPrice ?? quote.postMarketPrice ?? quote.preMarketPrice;
      row.querySelector(".currentPrice").textContent = priceNow.toFixed(2);
      row.querySelector(".currentPrice").classList.remove("loading");

      // 2. Cost basis
      let costBasis = 0;
      const manualPrice = parseFloat(row.querySelector(".price").value);
      if (manualPrice > 0) {
        costBasis = manualPrice * shares;
      } else if (row.querySelector(".purchaseDate").value) {
        const date = row.querySelector(".purchaseDate").value;
        try {
          const chartUrl = PROXY + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=5y&interval=1d`);
          const chart = await axios.get(chartUrl);
          const ts = chart.data.chart.result[0].timestamp;
          const close = chart.data.chart.result[0].indicators.quote[0].close;
          const target = new Date(date).getTime() / 1000;

          let priceAtDate = close[close.length-1]; // fallback
          for (let i = 0; i < ts.length; i++) {
            if (ts[i] >= target) { priceAtDate = close[i]; break; }
          }
          if (priceAtDate && !isNaN(priceAtDate)) {
            costBasis = priceAtDate * shares;
            row.querySelector(".price").value = priceAtDate.toFixed(2);
          }
        } catch (e) {
          row.querySelector(".purchaseDate").style.borderColor = "red";
        }
      }

      const marketValue = priceNow * shares;
      const gain = marketValue - costBasis;
      const gainPct = costBasis > 0 ? (gain / costBasis) * 100 : 0;

      row.querySelector(".cost").textContent = costBasis.toFixed(2);
      row.querySelector(".value").textContent = marketValue.toFixed(2);
      row.querySelector(".gain$").textContent = gain.toFixed(2);
      row.querySelector(".gain$").style.color = gain >= 0 ? "green" : "red";
      row.querySelector(".gainPct").textContent = gainPct.toFixed(1) + "%";
      row.querySelector(".gainPct").style.color = gain >= 0 ? "green" : "red";

      totalCost += costBasis;
      totalValue += marketValue;
    }

    updateSummary(totalValue, totalValue - totalCost);

  } catch (err) {
    console.error(err);
    alert("Data fetch failed. Try again in a few seconds or check ticker symbols.");
  }
}

function updateSummary(value, gain) {
  document.getElementById("totalValue").textContent = "$" + value.toFixed(2);
  const gainText = (gain >= 0 ? "+" : "") + "$" + gain.toFixed(2);
  document.getElementById("totalGain").textContent = gainText;
  document.getElementById("totalGain").style.color = gain >= 0 ? "green" : "red";
  const pct = totalCost > 0 ? (gain / totalCost * 100).toFixed(1) + "%" : "0%";
  document.getElementById("totalGainPct").textContent = pct;
  document.getElementById("totalGainPct").style.color = gain >= 0 ? "green" : "red";
}

// Start with one empty row
addRow();
</script>
</body>
</html>
