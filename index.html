<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stock Portfolio Tracker – Unlimited FMP Edition (No Rate Limits)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js"></script>
<style>
  body { font-family: system-ui, Arial, sans-serif; margin:20px; background:#f8f9fa; }
  h1 { text-align:center; color:#222; }
  button { padding:12px 24px; font-size:18px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; }
  table { width:100%; border-collapse:collapse; margin-top:20px; background:white; border-radius:12px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,0.1); }
  th { background:#28a745; color:white; padding:15px; text-align:left; }
  td { padding:12px; border-bottom:1px solid #eee; }
  input { padding:10px; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; font-size:16px; }
  .remove-btn { background:#dc3545; color:white; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  #summary { margin-top:30px; padding:25px; background:#d4edda; border-radius:12px; text-align:center; font-size:1.5em; font-weight:bold; }
  .loading { color:#ffc107; }
  .error { color:#dc3545; }
  #apiNote { text-align:center; color:#6c757d; margin:10px 0; font-style:italic; }
</style>
</head>
<body>

<h1>My Stock Portfolio Tracker (up to 10 stocks)</h1>
<div id="apiNote">Using free Financial Modeling Prep API (unlimited calls, no key needed)</div>

<div style="text-align:center; margin:25px 0;">
  <button id="addStock">+ Add Stock</button>
  <span style="margin-left:40px; font-size:18px;">
    Evaluation date: <input type="date" id="evalDate">
  </span>
</div>

<table id="portfolioTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Ticker</th>
      <th>Shares</th>
      <th>Purchase Price $</th>
      <th>OR Purchase Date</th>
      <th>Cost Basis</th>
      <th>Current Price</th>
      <th>Value Now</th>
      <th>Gain $</th>
      <th>Gain %</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="summary">
  Total portfolio value: <span id="totalValue">$0.00</span><br>
  Total gain/loss: <span id="totalGain">$0.00</span> (<span id="totalGainPct">0%</span>)
</div>

<script>
// FMP API – Unlimited free tier, batch quotes for efficiency
const FMP_BASE = "https://financialmodelingprep.com/api/v3";

const tbody = document.querySelector("#portfolioTable tbody");
const addBtn = document.getElementById("addStock");
const evalDateInput = document.getElementById("evalDate");
let rows = [];
let totalCost = 0;

evalDateInput.value = dayjs().format("YYYY-MM-DD");

function addRow() {
  if (rows.length >= 10) {
    alert("Maximum 10 stocks allowed");
    return;
  }

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="num">${rows.length + 1}</td>
    <td><input class="ticker" placeholder="AAPL"></td>
    <td><input type="number" class="shares" min="0" step="0.001" placeholder="100"></td>
    <td><input type="number" class="price" step="0.01" placeholder="or use date →"></td>
    <td><input type="date" class="purchaseDate"></td>
    <td class="cost">-</td>
    <td class="currentPrice loading">Loading…</td>
    <td class="value">-</td>
    <td class="gainDollar">-</td>
    <td class="gainPercent">-</td>
    <td><button class="remove-btn">X</button></td>
  `;

  tr.querySelector(".remove-btn").onclick = () => {
    tr.remove();
    rows = rows.filter(r => r !== tr);
    rows.forEach((r, i) => r.querySelector(".num").textContent = i + 1);
    refresh();
  };

  ["ticker", "shares", "price", "purchaseDate"].forEach(cls =>
    tr.querySelector(`.${cls}`).addEventListener("input", refresh)
  );

  tbody.appendChild(tr);
  rows.push(tr);
}

addBtn.onclick = addRow;
evalDateInput.onchange = refresh;

async function fetchPrices(tickers, isHistorical = false) {
  if (tickers.length === 0) return {};
  try {
    let endpoint = isHistorical ? "/historical-price-full" : "/quote";
    const params = isHistorical ? { symbol: tickers[0], from: "2020-01-01", to: evalDateInput.value || dayjs().format("YYYY-MM-DD") } : { symbols: tickers.join(",") };
    const { data } = await axios.get(`${FMP_BASE}${endpoint}`, { params });
    if (isHistorical) {
      // Single ticker historical
      const histData = data.historical || [];
      const targetDate = dayjs(evalDateInput.value || row.querySelector(".purchaseDate").value);
      let closestPrice = null;
      let minDiff = Infinity;
      for (const day of histData) {
        const dayDate = dayjs(day.date);
        if (dayDate.isBefore(targetDate) || dayDate.isSame(targetDate)) {
          const diff = Math.abs(dayDate.diff(targetDate, 'day'));
          if (diff < minDiff) {
            minDiff = diff;
            closestPrice = parseFloat(day.close);
          }
        }
      }
      return closestPrice;
    } else {
      // Batch current prices
      const priceMap = {};
      data.forEach(q => {
        if (q.symbol && !isNaN(q.price)) {
          priceMap[q.symbol] = parseFloat(q.price);
        }
      });
      return priceMap;
    }
  } catch (err) {
    console.error("FMP fetch error:", err);
    return isHistorical ? null : {};
  }
}

async function refresh() {
  totalCost = 0;
  let totalValue = 0;

  rows.forEach(r => {
    r.querySelector(".currentPrice").textContent = "Loading…";
    r.querySelector(".currentPrice").classList.add("loading");
    r.querySelector(".cost").textContent = "-";
    r.querySelector(".value").textContent = "-";
    r.querySelector(".gainDollar").textContent = "-";
    r.querySelector(".gainPercent").textContent = "-";
  });

  const tickers = rows.map(r => r.querySelector(".ticker").value.trim().toUpperCase()).filter(Boolean);
  if (tickers.length === 0) {
    updateSummary(0, 0);
    return;
  }

  // Batch fetch current prices (one call for all tickers)
  const priceMap = await fetchPrices(tickers);

  for (const row of rows) {
    const ticker = row.querySelector(".ticker").value.trim().toUpperCase();
    const shares = parseFloat(row.querySelector(".shares").value) || 0;
    if (!ticker || shares <= 0) continue;

    const priceNow = priceMap[ticker];
    if (priceNow === undefined) {
      row.querySelector(".currentPrice").textContent = "Error";
      row.querySelector(".currentPrice").classList.add("error");
      continue;
    }

    row.querySelector(".currentPrice").textContent = priceNow.toFixed(2);
    row.querySelector(".currentPrice").classList.remove("loading");

    // Cost basis
    let costBasis = 0;
    const manualPrice = parseFloat(row.querySelector(".price").value);
    if (manualPrice > 0) {
      costBasis = manualPrice * shares;
    } else {
      const purchaseDate = row.querySelector(".purchaseDate").value;
      if (purchaseDate) {
        const priceAtDate = await fetchPrices([ticker], true);
        if (priceAtDate) {
          costBasis = priceAtDate * shares;
          row.querySelector(".price").value = priceAtDate.toFixed(2);
        }
      }
    }

    const marketValue = priceNow * shares;
    const gain = marketValue - costBasis;
    const gainPct = costBasis > 0 ? (gain / costBasis) * 100 : 0;

    row.querySelector(".cost").textContent = costBasis.toFixed(2);
    row.querySelector(".value").textContent = marketValue.toFixed(2);
    row.querySelector(".gainDollar").textContent = gain.toFixed(2);
    row.querySelector(".gainDollar").style.color = gain >= 0 ? "green" : "red";
    row.querySelector(".gainPercent").textContent = gainPct.toFixed(1) + "%";
    row.querySelector(".gainPercent").style.color = gain >= 0 ? "green" : "red";

    totalCost += costBasis;
    totalValue += marketValue;
  }

  updateSummary(totalValue, totalValue - totalCost);
}

function updateSummary(value, gain) {
  document.getElementById("totalValue").textContent = "$" + value.toFixed(2);
  const gainText = (gain >= 0 ? "+" : "") + "$" + gain.toFixed(2);
  document.getElementById("totalGain").textContent = gainText;
  document.getElementById("totalGain").style.color = gain >= 0 ? "green" : "red";
  const pct = totalCost > 0 ? (gain / totalCost * 100).toFixed(1) + "%" : "0%";
  document.getElementById("totalGainPct").textContent = pct;
  document.getElementById("totalGainPct").style.color = gain >= 0 ? "green" : "red";
}

// Start with one row
addRow();
</script>
</body>
</html>
